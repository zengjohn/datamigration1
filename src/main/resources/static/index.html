<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¿ç§»è¿ç»´æ§åˆ¶å° V3.0</title>
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/bootstrap-icons.min.css" rel="stylesheet">
    <script src="/assets/js/vue.global.js"></script>
    <script src="/assets/js/axios.min.js"></script>

    <style>
        :root { --sidebar-width: 280px; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9rem; overflow-x: hidden;}

        /* å¸ƒå±€è°ƒæ•´ */
        .main-container { height: 100vh; display: flex; flex-direction: column; }
        .content-area { flex: 1; overflow: hidden; display: flex; }
        .sidebar { width: var(--sidebar-width); border-right: 1px solid #dee2e6; background: white; display: flex; flex-direction: column; }
        .workspace { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }

        /* å¡ç‰‡ä¼˜åŒ– */
        .card { box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #e9ecef; }
        .card-header { background-color: #fff; font-weight: 600; border-bottom: 2px solid #f1f3f5; padding: 0.75rem 1rem;}

        /* è¡¨æ ¼æ ·å¼ */
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .cursor-pointer { cursor: pointer; }
        .selected-row { background-color: #e7f1ff !important; border-left: 3px solid #0d6efd; }

        /* çŠ¶æ€å¾½ç«  */
        .badge { font-weight: 500; letter-spacing: 0.3px; }

        /* å³ä¾§æŠ½å±‰ (Drawer) */
        .drawer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 1040;
        }
        .drawer {
            position: fixed; top: 0; right: 0; height: 100%; width: 600px;
            background: white; box-shadow: -4px 0 10px rgba(0,0,0,0.1);
            z-index: 1050; transition: transform 0.3s ease-in-out;
            transform: translateX(100%); display: flex; flex-direction: column;
        }
        .drawer.open { transform: translateX(0); }
        .drawer-header { padding: 1rem; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;}
        .drawer-body { flex: 1; overflow-y: auto; padding: 0; }

        /* å·®å¼‚æŸ¥çœ‹å™¨ */
        .diff-modal { max-width: 900px; }
        .diff-content {
            background: #2b2b2b; color: #f8f8f2; padding: 1rem;
            border-radius: 4px; font-family: 'Consolas', monospace;
            white-space: pre-wrap; font-size: 0.85rem; max-height: 60vh; overflow: auto;
        }
    </style>
</head>
<body>

<div id="app" class="main-container">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-3 shadow-sm" style="height: 56px;">
        <span class="navbar-brand mb-0 h1"><i class="bi bi-hdd-network me-2"></i>æ•°æ®è¿ç§»è¿ç»´æ§åˆ¶å°</span>
        <div class="ms-auto d-flex align-items-center gap-3">
            <div class="form-check form-switch text-white">
                <input class="form-check-input" type="checkbox" v-model="autoRefresh" id="refreshSwitch">
                <label class="form-check-label small" for="refreshSwitch">è‡ªåŠ¨åˆ·æ–°</label>
            </div>
            <button class="btn btn-sm btn-light text-primary fw-bold" @click="openCreateModal">
                <i class="bi bi-plus-lg"></i> æ–°å»ºä½œä¸š
            </button>
        </div>
    </nav>

    <div class="content-area">
        <div class="sidebar">
            <div class="p-3 border-bottom bg-light">
                <input type="text" class="form-control form-control-sm" placeholder="ğŸ” æœç´¢ä½œä¸š..." v-model="jobSearch">
            </div>
            <div class="flex-grow-1 overflow-auto">
                <div v-if="loadingJobs" class="text-center p-3 text-muted">åŠ è½½ä¸­...</div>
                <div class="list-group list-group-flush">
                    <a href="#" v-for="job in filteredJobs" :key="job.id"
                       class="list-group-item list-group-item-action py-3"
                       :class="{'selected-row': selectedJob?.id === job.id}"
                       @click="selectJob(job)">
                        <div class="d-flex w-100 justify-content-between mb-1">
                            <strong class="text-truncate" style="max-width: 160px;" :title="job.name">{{ job.name }}</strong>
                            <span :class="getStatusClass(job.status)" class="badge-sm">{{ job.status }}</span>
                        </div>
                        <div class="small text-muted text-truncate" :title="job.sourceDirectory">
                            <i class="bi bi-folder2-open me-1"></i>{{ job.sourceDirectory }}
                        </div>
                        <div class="mt-2" v-if="selectedJob?.id === job.id">
                            <button v-if="job.status === 'ACTIVE'" @click.stop="jobAction(job, 'stop')" class="btn btn-outline-danger btn-xs w-100" style="font-size: 0.75rem;">åœæ­¢ä½œä¸š</button>
                            <button v-if="job.status === 'STOPPED'" @click.stop="jobAction(job, 'resume')" class="btn btn-outline-success btn-xs w-100" style="font-size: 0.75rem;">æ¢å¤ä½œä¸š</button>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <div class="workspace">

            <div v-if="!selectedJob" class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                <i class="bi bi-arrow-left-circle display-4 mb-3"></i>
                <h5>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè¿ç§»ä½œä¸š</h5>
            </div>

            <template v-else>
                <div class="card flex-shrink-0" style="max-height: 45%;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-collection me-2"></i>æ‰¹æ¬¡åˆ—è¡¨ (OKæ–‡ä»¶)</span>
                        <button class="btn btn-sm btn-outline-secondary" @click="fetchBatches"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0 align-middle">
                            <thead class="table-light sticky-top">
                            <tr>
                                <th>ID</th><th>OKæ–‡ä»¶å</th><th>ç›®æ ‡è¡¨</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="b in batches" :key="b.id"
                                @click="selectBatch(b)"
                                class="cursor-pointer"
                                :class="{'selected-row': selectedBatch?.id === b.id}">
                                <td>{{ b.id }}</td>
                                <td>
                                    <div class="fw-bold">{{ getFileName(b.okFilePath) }}</div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">{{ b.okFilePath }}</div>
                                </td>
                                <td>{{ b.tableName }}</td>
                                <td>
                                    <span :class="getStatusClass(b.status)">{{ b.status }}</span>
                                    <div v-if="b.errorMsg" class="text-danger small mt-1 text-truncate" style="max-width: 200px;" :title="b.errorMsg">{{ b.errorMsg }}</div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button v-if="b.status === 'FAIL_PARSE'" @click.stop="retryBatch(b)" class="btn btn-warning" title="é‡è¯•è§£æ"><i class="bi bi-arrow-repeat"></i></button>
                                        <button v-if="b.status !== 'FINISHED'" @click.stop="closeBatch(b)" class="btn btn-success" title="å¼ºåˆ¶ç»“å•"><i class="bi bi-check-circle"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="batches.length === 0"><td colspan="5" class="text-center p-3 text-muted">æš‚æ— æ‰¹æ¬¡æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card flex-grow-1 d-flex flex-column" v-if="selectedBatch">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-2">
                        <span>
                            <i class="bi bi-file-earmark-spreadsheet me-2"></i>æ–‡ä»¶æ˜ç»†
                            <span class="badge bg-secondary ms-2">{{ selectedBatch.tableName }}</span>
                        </span>
                        <div>
                            <span class="small text-muted me-3">ç¬¬ {{ pageConfig.page + 1 }} / {{ detailsData.totalPages }} é¡µ</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" :disabled="detailsData.first" @click="changePage(-1)">ä¸Šä¸€é¡µ</button>
                                <button class="btn btn-outline-secondary" :disabled="detailsData.last" @click="changePage(1)">ä¸‹ä¸€é¡µ</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive flex-grow-1">
                        <table class="table table-hover table-sm mb-0 align-middle">
                            <thead class="table-light">
                            <tr><th>ID</th><th>æºCSVè·¯å¾„</th><th>çŠ¶æ€</th><th>è¿›åº¦</th><th>å¤±è´¥è¡Œæ•°</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th></tr>
                            </thead>
                            <tbody>
                            <tr v-for="d in detailsData.content" :key="d.id">
                                <td>{{ d.id }}</td>
                                <td class="small">{{ d.sourceCsvPath }}</td>
                                <td><span :class="getStatusClass(d.status)">{{ d.status }}</span></td>
                                <td>
                                    <div class="progress" style="height: 6px; width: 80px;">
                                        <div class="progress-bar" :class="d.progress===100?'bg-success':'bg-primary'" :style="{width: (d.progress||0)+'%'}"></div>
                                    </div>
                                </td>
                                <td>
                                    <div v-if="d.transcodeErrorCount > 0" class="d-flex align-items-center text-danger fw-bold">
                                        <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                        {{ d.transcodeErrorCount }}
                                        <button class="btn btn-link btn-sm text-danger p-0 ms-2 text-decoration-none"
                                                @click.stop="viewBadFile(d)" title="æŸ¥çœ‹å¤±è´¥å†…å®¹">
                                            [æŸ¥çœ‹]
                                        </button>
                                    </div>
                                    <span v-else class="text-muted">-</span>
                                </td>
                                <td class="small text-muted">{{ formatTime(d.updateTime) }}</td>
                                <td>
                                    <button @click="openSplits(d)" class="btn btn-outline-primary btn-sm py-0 me-1">åˆ‡ç‰‡ç›‘æ§</button>
                                    <button v-if="['FAIL_TRANSCODE','FINISHED_WITH_ERROR'].includes(d.status)" @click="retryTranscode(d)" class="btn btn-outline-warning btn-sm py-0">é‡è¯•è½¬ç </button>
                                </td>
                            </tr>
                            <tr v-if="detailsData.content.length === 0"><td colspan="6" class="text-center p-4 text-muted">è¯¥æ‰¹æ¬¡ä¸‹æ—  CSV æ–‡ä»¶</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card flex-grow-1 d-flex align-items-center justify-content-center text-muted" v-else>
                    <div class="text-center">
                        <i class="bi bi-arrow-up-circle display-6"></i>
                        <p class="mt-2">è¯·ç‚¹å‡»ä¸Šæ–¹çš„æ‰¹æ¬¡ä»¥æŸ¥çœ‹æ˜ç»†</p>
                    </div>
                </div>

            </template>
        </div>
    </div>

    <div class="drawer-overlay" v-if="showSplitDrawer" @click="showSplitDrawer = false"></div>
    <div class="drawer" :class="{open: showSplitDrawer}">
        <div class="drawer-header flex-column align-items-stretch gap-2">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-truncate">
                    <i class="bi bi-layers me-2"></i>åˆ‡ç‰‡æ§åˆ¶å°
                    <span class="badge bg-secondary ms-2" style="font-size: 0.8rem">Detail ID: {{ selectedDetail?.id }}</span>
                </h5>
                <button type="button" class="btn-close" @click="showSplitDrawer = false"></button>
            </div>

            <div class="d-flex gap-2 align-items-center">
                <div class="input-group input-group-sm" style="width: 120px;">
                    <input type="text" class="form-control" placeholder="åˆ‡ç‰‡ID" v-model="splitQuery.id" @keyup.enter="loadSplits">
                </div>

                <select class="form-select form-select-sm" v-model="splitQuery.status" @change="loadSplits" style="width: 140px;">
                    <option value="">-- æ‰€æœ‰çŠ¶æ€ --</option>
                    <option value="FAIL_LOAD,FAIL_VERIFY">âš ï¸ æ‰€æœ‰å¼‚å¸¸</option>
                    <option value="FAIL_LOAD">âŒ è£…è½½å¤±è´¥</option>
                    <option value="FAIL_VERIFY">âŒ éªŒè¯ä¸ç¬¦</option>
                    <option value="WAIT_LOAD">â³ ç­‰å¾…è£…è½½</option>
                    <option value="PASS">âœ… æˆåŠŸ (PASS)</option>
                </select>

                <button class="btn btn-sm btn-primary" @click="loadSplits"><i class="bi bi-search"></i></button>
            </div>

            <div class="d-flex gap-3 small text-muted border-top pt-2 mt-1">
                <span>å½“å‰æ˜¾ç¤º: {{ splitPage.content.length }} / æ€»æ•°: {{ splitPage.totalElements }}</span>
            </div>
        </div>
        <div class="drawer-body p-0">
            <div class="alert alert-light border-bottom mb-0 small text-muted">
                <i class="bi bi-info-circle me-1"></i> æºæ–‡ä»¶: {{ getFileName(selectedDetail?.sourceCsvPath) }}
            </div>
            <table class="table table-striped table-hover table-sm mb-0 small align-middle">
                <thead class="table-light sticky-top">
                <tr><th>ID</th><th>åˆ‡ç‰‡å</th><th>çŠ¶æ€/é”™è¯¯</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody>
                <tr v-for="s in splitPage.content" :key="s.id">
                    <td>{{ s.id }}</td>
                    <td>{{ getFileName(s.splitFilePath) }}</td>
                    <td>
                        <div :class="getStatusClass(s.status)" class="badge mb-1">{{ s.status }}</div>
                        <div v-if="s.errorMsg" class="text-danger text-break" style="font-size: 0.75rem; line-height: 1.2;">{{ s.errorMsg }}</div>
                    </td>
                    <td>
                        <button @click="downloadSplit(s)"
                                class="btn btn-outline-primary btn-xs w-100 mb-1"
                                title="ä¸‹è½½åˆ°æœ¬åœ°">
                            <i class="bi bi-download"></i> ä¸‹è½½
                        </button>

                        <button v-if="s.status === 'FAIL_LOAD'"
                                @click="retrySplit(s)"
                                class="btn btn-warning btn-xs w-100 mb-1">
                            <i class="bi bi-arrow-repeat"></i> é‡è¯•åŠ è½½
                        </button>

                        <div v-if="s.status === 'FAIL_VERIFY'" class="d-flex gap-1 mb-1">
                            <button @click="reVerifySplit(s)"
                                    class="btn btn-info btn-xs flex-grow-1" title="ä»…é‡æ–°è¿è¡Œæ¯”å¯¹">
                                é‡éªŒ
                            </button>
                            <button @click="retrySplit(s)"
                                    class="btn btn-outline-warning btn-xs" title="åˆ é™¤æ•°æ®é‡æ–°è£…è½½">
                                é‡è½½
                            </button>
                        </div>

                        <button v-if="s.status === 'PASS'"
                                @click="reVerifySplit(s)"
                                class="btn btn-outline-secondary btn-xs w-100 mb-1">
                            <i class="bi bi-search"></i> å¤æ ¸
                        </button>

                        <button v-if="s.status === 'FAIL_VERIFY'"
                                @click="viewDiff(s)"
                                class="btn btn-danger btn-xs w-100">
                            æŸ¥çœ‹å·®å¼‚
                        </button>
                    </td>
                </tr>

                <tr v-if="!splitPage.content || splitPage.content.length === 0">
                    <td colspan="4" class="text-center text-muted p-3">
                        æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åˆ‡ç‰‡æ•°æ®
                    </td>
                </tr>
                </tbody>>
            </table>

            <div class="p-2 border-top bg-light d-flex justify-content-between align-items-center">
                <button class="btn btn-sm btn-outline-secondary"
                        :disabled="splitPage.first"
                        @click="changeSplitPage(-1)">ä¸Šä¸€é¡µ</button>
                <span class="small">ç¬¬ {{ splitPage.number + 1 }} / {{ splitPage.totalPages }} é¡µ</span>
                <button class="btn btn-sm btn-outline-secondary"
                        :disabled="splitPage.last"
                        @click="changeSplitPage(1)">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <div class="modal fade show" v-if="showDiffModal" style="display: block; background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered diff-modal">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h5 class="modal-title fs-6">âš–ï¸ æ•°æ®æ¯”å¯¹å·®å¼‚ (Top 200 è¡Œ)</h5>
                    <button type="button" class="btn-close" @click="showDiffModal = false"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="diff-content">{{ diffContent }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade show" v-if="showCreateJobModal" style="display: block; background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å»ºè¿ç§»ä½œä¸š</h5>
                    <button type="button" class="btn-close" @click="showCreateJobModal = false"></button>
                </div>
                <div class="modal-body">
                    <div v-if="createJobError" class="alert alert-danger py-2 small d-flex align-items-center">
                        <i class="bi bi-exclamation-circle-fill me-2"></i>
                        <span class="text-break">{{ createJobError }}</span>
                    </div>

                    <form @submit.prevent="submitCreateJob">
                        <div class="mb-3">
                            <label class="form-label small">ä½œä¸šåç§°</label>
                            <input v-model="newJob.name" type="text" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">ç›‘æ§æºç›®å½•</label>
                            <input v-model="newJob.sourceDirectory" type="text" class="form-control" placeholder="/data/..." required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">è¾“å‡ºç›®å½•</label>
                            <input v-model="newJob.outDirectory" type="text" class="form-control" placeholder="/outdata/..." required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">ç›®æ ‡æ•°æ®åº“ JDBC URL</label>
                            <input v-model="newJob.targetDbUrl" type="text" class="form-control form-control-sm">
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label small">ç”¨æˆ·</label>
                                <input v-model="newJob.targetDbUser" type="text" class="form-control form-control-sm">
                            </div>
                            <div class="col">
                                <label class="form-label small">å¯†ç </label>
                                <input v-model="newJob.targetDbPass" type="password" class="form-control form-control-sm">
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-light me-2" @click="showCreateJobModal = false">å–æ¶ˆ</button>
                            <button type="submit" class="btn btn-primary">æäº¤</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, reactive, computed, onMounted, onUnmounted, watch } = Vue;
    const API_BASE = window.location.origin + '/api/migration';

    // ã€æ–°å¢ã€‘Axios è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨ç»™æ‰€æœ‰ GET è¯·æ±‚åŠ æ—¶é—´æˆ³
    axios.interceptors.request.use(config => {
        if (config.method === 'get') {
            // å¦‚æœ params ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡
            config.params = config.params || {};
            // æ·»åŠ  _t å‚æ•°ï¼Œå€¼ä¸ºå½“å‰æ—¶é—´æˆ³
            config.params['_t'] = new Date().getTime();
        }
        return config;
    }, error => {
        return Promise.reject(error);
    });

    createApp({
        setup() {
            // --- çŠ¶æ€æ•°æ® ---
            const jobs = ref([]);
            const batches = ref([]);
            const detailsData = ref({ content: [], totalPages: 0, first: true, last: true });
            const splits = ref([]);

            const selectedJob = ref(null);
            const selectedBatch = ref(null);
            const selectedDetail = ref(null);

            const jobSearch = ref('');
            const loadingJobs = ref(false);
            const autoRefresh = ref(true);
            const pageConfig = reactive({ page: 0, size: 10 });

            // UI å¼€å…³
            const showCreateJobModal = ref(false);
            const showSplitDrawer = ref(false);
            const showDiffModal = ref(false);
            const diffContent = ref('');
            const newJob = reactive({ name: '', sourceDirectory: '', targetDbUrl: '', targetDbUser: 'root', targetDbPass: '' });
            // ã€æ–°å¢ã€‘ç”¨äºå­˜å‚¨æ–°å»ºä½œä¸šæ—¶çš„æŠ¥é”™ä¿¡æ¯
            const createJobError = ref('');

            let timer = null;
            // æ–°å¢ä¸€ä¸ªå“åº”å¼å˜é‡
            const filterErrorOnly = ref(false);

            // ã€æ–°å¢ã€‘åˆ‡ç‰‡åˆ†é¡µæ•°æ®å®¹å™¨
            const splitPage = ref({
                content: [],
                totalElements: 0,
                totalPages: 0,
                number: 0,
                first: true,
                last: true
            });
            // ã€æ–°å¢ã€‘åˆ‡ç‰‡æŸ¥è¯¢æ¡ä»¶
            const splitQuery = reactive({
                id: '',
                status: '',
                page: 0,
                size: 20
            });



            // --- æ ¸å¿ƒæ•°æ®è·å– ---
            const loadJobs = async () => {
                loadingJobs.value = true;
                try {
                    const res = await axios.get(`${API_BASE}/jobs`);
                    jobs.value = res.data;
                } finally { loadingJobs.value = false; }
            };

            const fetchBatches = async () => {
                if (!selectedJob.value) return;
                const res = await axios.get(`${API_BASE}/job/${selectedJob.value.id}/batches`);
                batches.value = res.data;
            };


            const viewBadFile = async (detail) => {
                try {
                    const res = await axios.get(`${API_BASE}/detail/${detail.id}/bad-content`);
                    diffContent.value = res.data;
                    showDiffModal.value = true; // å¤ç”¨å·®å¼‚æŸ¥çœ‹çš„å¼¹çª—
                } catch(e) {
                    alert("æ— æ³•è¯»å–å¤±è´¥æ–‡ä»¶: " + (e.response?.data || e.message));
                }
            };

            const fetchDetails = async () => {
                // 1. å¿…é¡»å…ˆé€‰ä¸­æ‰¹æ¬¡
                if (!selectedBatch.value) return;
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åç«¯æ”¯æŒæ ¹æ® qianyiId (batchId) æŸ¥è¯¢
                // å‡è®¾åç«¯æ¥å£å·²æŒ‰å»ºè®®ä¿®æ”¹ä¸º: /api/migration/batch/{batchId}/details?page=0&size=10
                // å¦‚æœæš‚æ—¶æ²¡æœ‰ï¼Œå¯ä»¥ç”¨ /job/{id}/details ä½†éœ€è¦å‰ç«¯è¿‡æ»¤ (ä¸æ¨èï¼Œæ•°æ®é‡å¤§)
                // è¿™é‡ŒæŒ‰æœ€ä½³å®è·µè°ƒç”¨ï¼š
                try {
                    // å‡è®¾åç«¯æ¥å£: GET /api/migration/job/{jobId}/details?page=..&size=.. (è¿”å›çš„æ˜¯å…¨éƒ¨)
                    // ä¸ºäº†æ¼”ç¤ºåˆ†é¡µï¼Œæˆ‘ä»¬æš‚æ—¶è°ƒç”¨ Job çº§åˆ«çš„åˆ†é¡µæ¥å£ (å› ä¸ºä¹‹å‰æ²¡å®šä¹‰ Batch çº§åˆ«çš„åˆ†é¡µæ¥å£)
                    // TODO: ç”Ÿäº§ç¯å¢ƒå»ºè®®å®ç° /api/migration/batch/{batchId}/details
                    const res = await axios.get(`${API_BASE}/batch/${selectedBatch.value.id}/details`, {
                        params: { page: pageConfig.page, size: pageConfig.size }
                    });

                    // å‰ç«¯ä¸´æ—¶è¿‡æ»¤: åªæ˜¾ç¤ºå±äºå½“å‰ Batch çš„ (å®é™…åº”ç”±åç«¯åš)
                    // ç”±äºåç«¯è¿”å›çš„æ˜¯ Page å¯¹è±¡ï¼Œå‰ç«¯è¿‡æ»¤ä¼šå¯¼è‡´é¡µç ä¸å¯¹ã€‚
                    // æ­¤å¤„å‡è®¾åç«¯è¿”å›çš„æ•°æ®å°±æ˜¯æˆ‘ä»¬è¦çš„ï¼Œæˆ–è€…åç«¯åŠ äº† qianyiId å‚æ•°
                    // æ¼”ç¤ºä»£ç ç›´æ¥ä½¿ç”¨è¿”å›ç»“æœ
                    detailsData.value = res.data;
                } catch(e) { console.error("åŠ è½½æ˜ç»†å¤±è´¥", e); }
            };

            // --- äº¤äº’åŠ¨ä½œ ---
            const selectJob = (job) => {
                selectedJob.value = job;
                selectedBatch.value = null;
                selectedDetail.value = null;
                batches.value = [];
                detailsData.value = { content: [] };
                fetchBatches();
            };

            const selectBatch = (batch) => {
                selectedBatch.value = batch;
                pageConfig.page = 0; // åˆ‡æ¢æ‰¹æ¬¡æ—¶é‡ç½®é¡µç 
                fetchDetails();
            };

            const changePage = (delta) => {
                pageConfig.page += delta;
                fetchDetails();
            };

            // --- ä¸šåŠ¡æ“ä½œ ---
            const openCreateModal = () => {
                createJobError.value = ''; // æ¯æ¬¡æ‰“å¼€å¼¹çª—å…ˆæ¸…ç©ºé”™è¯¯
                // é‡ç½®è¡¨å•æ•°æ®ï¼ˆå¯é€‰ï¼‰
                Object.assign(newJob, { name: '', sourceDirectory: '', targetDbUrl: '', targetDbUser: 'root', targetDbPass: '' });
                showCreateJobModal.value = true;
            };

            const submitCreateJob = async () => {
                createJobError.value = ''; // æäº¤å‰å…ˆæ¸…ç©ºæ—§é”™è¯¯
                try {
                    await axios.post(`${API_BASE}/job/create`, newJob);

                    // æˆåŠŸåå…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
                    showCreateJobModal.value = false;
                    loadJobs();
                } catch(e) {
                    // ã€å…³é”®ä¿®å¤ã€‘æå–åç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯
                    // Spring Boot çš„ ResponseEntity.badRequest().body("é”™è¯¯ä¿¡æ¯") ä¼šæ”¾åœ¨ e.response.data ä¸­
                    const errorMsg = e.response?.data || e.message || "æœªçŸ¥ç½‘ç»œé”™è¯¯";
                    createJobError.value = errorMsg;

                    // æ³¨æ„ï¼šè¿™é‡Œä¸è¦å…³é—­å¼¹çª— (showCreateJobModal.value = false)ï¼Œ
                    // è¿™æ ·ç”¨æˆ·å¯ä»¥çœ‹åˆ°é”™è¯¯å¹¶ä¿®æ”¹è¡¨å•
                }
            };

            const jobAction = async (job, action) => {
                if(!confirm(`ç¡®è®¤${action === 'stop' ? 'åœæ­¢' : 'æ¢å¤'}è¯¥ä½œä¸šå—ï¼Ÿ`)) return;
                await axios.post(`${API_BASE}/job/${job.id}/action?action=${action}`);
                loadJobs();
            };

            const retryBatch = async (batch) => {
                if(!confirm('ç¡®å®šè¦é‡è¯•æ­¤æ‰¹æ¬¡å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³æ˜ç»†å¹¶é‡æ–°æ‰«æã€‚')) return;
                await axios.post(`${API_BASE}/batch/${batch.id}/retry`);
                fetchBatches();
            };

            const closeBatch = async (batch) => {
                if(!confirm('ç¡®å®šè¦å¼ºåˆ¶ç»“å•å—ï¼Ÿ')) return;
                await axios.post(`${API_BASE}/batch/${batch.id}/close`);
                fetchBatches();
            };

            const retryTranscode = async (detail) => {
                await axios.post(`${API_BASE}/detail/${detail.id}/retry-transcode`);
                fetchDetails();
            };

            // --- æ–°å¢ï¼šä¸‹è½½åˆ‡ç‰‡æ–‡ä»¶é€»è¾‘ ---
            const downloadSplit = async (split) => {
                try {
                    // ç®€å•çš„ç”¨æˆ·æç¤ºï¼Œè™½ç„¶æµè§ˆå™¨ä¹Ÿä¼šæ˜¾ç¤ºä¸‹è½½è¿›åº¦
                    // å¦‚æœæ‚¨æƒ³åŠ ä¸ª loading çŠ¶æ€ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ä¸€ä¸ª ref

                    const response = await axios.get(`${API_BASE}/split/${split.id}/download`, {
                        responseType: 'blob' // ã€å…³é”®ã€‘å¿…é¡»è®¾ç½®ä¸º blob
                    });

                    // 1. å°è¯•ä» Header è·å–æ–‡ä»¶å
                    // åç«¯ Header æ ¼å¼: Content-Disposition: attachment; filename="split_123.csv"
                    const disposition = response.headers['content-disposition'];
                    let filename = `split_${split.id}.csv`; // é»˜è®¤ä¿åº•æ–‡ä»¶å

                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }

                    // 2. åˆ›å»º Blob URL å¹¶è§¦å‘æµè§ˆå™¨ä¸‹è½½
                    const blob = new Blob([response.data], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', filename);
                    document.body.appendChild(link);
                    link.click();

                    // 3. æ¸…ç†å†…å­˜
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                } catch (error) {
                    console.error("ä¸‹è½½å¤±è´¥", error);

                    // ã€å…³é”®é”™è¯¯å¤„ç†ã€‘å› ä¸º responseType æ˜¯ blobï¼Œå¦‚æœåç«¯æŠ¥é”™ï¼ˆæ¯”å¦‚è¿”å›JSONæ ¼å¼çš„é”™è¯¯ä¿¡æ¯ï¼‰ï¼Œ
                    // æˆ‘ä»¬éœ€è¦æŠŠ blob è½¬å›æ–‡æœ¬æ‰èƒ½çœ‹åˆ°æŠ¥é”™å†…å®¹
                    if (error.response && error.response.data instanceof Blob) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const errorText = reader.result;
                            alert("ä¸‹è½½å¤±è´¥: " + (errorText || "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"));
                        };
                        reader.readAsText(error.response.data);
                    } else {
                        alert("ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ—¥å¿—");
                    }
                }
            };

            // 1. é‡è¯•åŠ è½½ (å¯¹åº”åç«¯ /retry æ¥å£ï¼Œé€šå¸¸é‡ç½®ä¸º WAIT_LOAD)
            const retrySplit = async (split) => {
                if(!confirm('ç¡®å®šè¦é‡è¯•åŠ è½½å—ï¼Ÿ(å°†åˆ é™¤æ—§æ•°æ®å¹¶é‡æ–°LOAD)')) return;
                try {
                    await axios.post(`${API_BASE}/split/${split.id}/retry`);
                    // ä¹è§‚æ›´æ–°ï¼šæ ¹æ®å½“å‰çŠ¶æ€åˆ¤æ–­ä¸‹ä¸€æ­¥
                    if (split.status === 'FAIL_LOAD') {
                        split.status = 'WAIT_LOAD';
                    } else {
                        // å¦‚æœæ˜¯å…¶ä»–çŠ¶æ€(å¦‚ FAIL_TRANSCODE)ï¼Œé€šå¸¸ä¹Ÿæ˜¯å›åˆ° WAIT_LOAD æˆ– NEW
                        split.status = 'WAIT_LOAD';
                    }
                    split.errorMsg = '';
                } catch(e) { alert("æ“ä½œå¤±è´¥"); }
            };

            // 2. é‡æ–°éªŒè¯ (å¯¹åº”åç«¯ /reverify æ¥å£ï¼Œé‡ç½®ä¸º WAIT_VERIFY)
            // è¦†ç›– FAIL_VERIFY å’Œ PASS ä¸¤ç§æƒ…å†µ
            const reVerifySplit = async (split) => {
                if(!confirm('ç¡®å®šè¦é‡æ–°æ ¡éªŒå—ï¼Ÿ(ä»…æ¯”å¯¹ï¼Œä¸é‡æ–°åŠ è½½)')) return;

                try {
                    await axios.post(`${API_BASE}/split/${split.id}/reverify`);
                    // ä¹è§‚æ›´æ–° UIï¼šè®©ç”¨æˆ·ç«‹åˆ»çœ‹åˆ°çŠ¶æ€å˜äº†
                    split.status = 'WAIT_VERIFY';
                    split.errorMsg = ''; // æ¸…ç©ºé”™è¯¯æ˜¾ç¤º
                } catch(e) {
                    alert("æ“ä½œå¤±è´¥: " + (e.response?.data || e.message));
                }
            };

            const viewDiff = async (split) => {
                try {
                    const res = await axios.get(`${API_BASE}/split/${split.id}/diff-content`);
                    diffContent.value = res.data;
                    showDiffModal.value = true;
                } catch(e) { alert("æ— æ³•è¯»å–å·®å¼‚æ–‡ä»¶"); }
            };

            // åŠ è½½åˆ‡ç‰‡æ•°æ® (æ ¸å¿ƒæ–¹æ³•)
            // ã€æ–°å¢ã€‘æ ¸å¿ƒåŠ è½½æ–¹æ³•ï¼šè°ƒç”¨åç«¯æœç´¢æ¥å£
            const loadSplits = async () => {
                if (!selectedDetail.value) return;

                try {
                    // æ„é€ æŸ¥è¯¢å‚æ•°
                    const params = {
                        page: splitQuery.page,
                        size: splitQuery.size,
                        // å¦‚æœè¾“å…¥æ¡†æ˜¯ç©ºçš„ï¼Œå°±ä¸ä¼ è¿™ä¸ªå‚æ•°ï¼Œåç«¯ä¼šå¿½ç•¥
                        splitId: splitQuery.id || undefined,
                        status: splitQuery.status || undefined
                    };

                    // è°ƒç”¨åˆšæ‰å®šä¹‰çš„åç«¯æ–°æ¥å£
                    const res = await axios.get(`${API_BASE}/detail/${selectedDetail.value.id}/splits/search`, { params });
                    splitPage.value = res.data;
                } catch(e) {
                    console.error(e);
                    alert("åŠ è½½åˆ‡ç‰‡æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ¥å£æ˜¯å¦æ›´æ–°");
                }
            };

            // ã€ä¿®æ”¹ã€‘æ‰“å¼€æŠ½å±‰çš„æ–¹æ³• (æ›¿æ¢åŸæ¥çš„ openSplits)
            const openSplits = (detail) => {
                selectedDetail.value = detail;
                showSplitDrawer.value = true;

                // é‡ç½®æŸ¥è¯¢æ¡ä»¶
                splitQuery.id = '';
                splitQuery.status = '';
                splitQuery.page = 0;

                // åŠ è½½ç¬¬ä¸€é¡µ
                loadSplits();
            };

            // ã€æ–°å¢ã€‘åˆ‡ç‰‡ç¿»é¡µ
            const changeSplitPage = (delta) => {
                splitQuery.page += delta;
                loadSplits();
            };

            // --- å·¥å…·å‡½æ•° ---
            const filteredJobs = computed(() => {
                if(!jobSearch.value) return jobs.value;
                return jobs.value.filter(j => j.name.includes(jobSearch.value) || j.sourceDirectory.includes(jobSearch.value));
            });

            const getFileName = (path) => path ? path.split(/[/\\]/).pop() : '-';
            const formatTime = (t) => t ? t.replace('T', ' ').substring(5, 19) : '-';
            const getStatusClass = (s) => {
                const map = {
                    'ACTIVE': 'badge bg-primary', 'STOPPED': 'badge bg-secondary',
                    'NEW': 'badge bg-secondary', 'TRANSCODING': 'badge bg-warning text-dark',
                    'PROCESSING_CHILDS': 'badge bg-info text-dark',
                    'FINISHED': 'badge bg-success', 'FINISHED_WITH_ERROR': 'badge bg-danger',
                    'WAIT_LOAD': 'badge bg-light text-dark border', 'LOADING': 'badge bg-primary',
                    'WAIT_VERIFY': 'badge bg-info text-dark', 'VERIFYING': 'badge bg-info',
                    'PASS': 'badge bg-success', 'FAIL_LOAD': 'badge bg-danger', 'FAIL_VERIFY': 'badge bg-danger', 'FAIL_TRANSCODE': 'badge bg-danger'
                };
                return map[s] || 'badge bg-secondary';
            };

            // --- ç”Ÿå‘½å‘¨æœŸ ---
            onMounted(() => {
                loadJobs();
                timer = setInterval(() => {
                    if(autoRefresh.value) {
                        // æ™ºèƒ½åˆ·æ–°ï¼šåªåˆ·æ–°å½“å‰æ‰“å¼€çš„è§†å›¾
                        if(!selectedJob.value) loadJobs();
                        else {
                            fetchBatches(); // åˆ·æ–°æ‰¹æ¬¡çŠ¶æ€
                            if(selectedBatch.value) fetchDetails(); // åˆ·æ–°æ˜ç»†è¿›åº¦
                            if(showSplitDrawer.value && selectedDetail.value) {
                                // æ–°çš„è°ƒç”¨æ–¹å¼ï¼šå¤ç”¨ loadSplits æ–¹æ³•ï¼Œè‡ªåŠ¨å¸¦ä¸Šå½“å‰çš„åˆ†é¡µå’ŒæŸ¥è¯¢å‚æ•°
                                loadSplits();
                            }
                        }
                    }
                }, 3000);
            });
            onUnmounted(() => clearInterval(timer));

            return {
                jobs, batches, detailsData, splits,
                reVerifySplit,downloadSplit,
                filterErrorOnly,
                selectedJob, selectedBatch, selectedDetail,
                jobSearch, filteredJobs, pageConfig, loadingJobs, autoRefresh,
                showCreateJobModal, showSplitDrawer, showDiffModal, diffContent, newJob,

                splitPage,
                splitQuery,
                loadSplits,
                changeSplitPage,

                createJobError,
                openCreateModal,
                submitCreateJob,
                selectJob, selectBatch, changePage, openSplits,
                jobAction, retryBatch, closeBatch, retryTranscode, retrySplit, viewDiff,

                getFileName, formatTime, getStatusClass,
                fetchBatches, // export for manual refresh btn
                viewBadFile
            };
        }
    }).mount('#app');
</script>
</body>
</html>