<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¿ç§»è¿ç»´æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .card-header { font-weight: 600; }
        .cursor-pointer { cursor: pointer; }
        .hover-row:hover { background-color: #e9ecef !important; }
        .selected-row { background-color: #e2e6ea; border-left: 4px solid #0d6efd; }
        /* é®ç½©å±‚æ ·å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1050;
        }
        /* å¼¹çª—å¤§å°æ§åˆ¶ */
        .modal-card-lg { width: 90%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-card-sm { width: 90%; max-width: 600px; background: white; border-radius: 8px; overflow: hidden;}
        .modal-body-scroll { overflow-y: auto; }
    </style>
</head>
<body>

<div id="app" class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ğŸš€ æ•°æ®è¿ç§»è¿ç»´æ§åˆ¶å°</h3>
        <div>
            <button class="btn btn-primary me-3" @click="openCreateModal">
                + æ–°å»ºè¿ç§»ä½œä¸š
            </button>

            <span class="text-muted small me-2">è‡ªåŠ¨åˆ·æ–°: {{ autoRefresh ? 'å¼€å¯' : 'å…³é—­' }}</span>
            <button class="btn btn-outline-secondary btn-sm" @click="toggleAutoRefresh">
                {{ autoRefresh ? 'â¸ æš‚åœ' : 'â–¶ å¼€å¯' }}
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-white text-primary">1. è¿ç§»ä½œä¸šåˆ—è¡¨</div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                        <tr><th>åç§°</th><th>ç›‘æ§ç›®å½•</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                        <tr v-for="job in jobs" :key="job.id"
                            @click="selectJob(job)"
                            class="cursor-pointer hover-row"
                            :class="{ 'selected-row': selectedJob?.id === job.id }">
                            <td>
                                <div class="fw-bold">{{ job.name }}</div>
                                <div class="small text-muted">ID: {{ job.id }}</div>
                            </td>
                            <td class="small text-muted" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" :title="job.sourceDirectory">
                                {{ job.sourceDirectory }}
                            </td>
                            <td><span :class="getStatusClass(job.status)">{{ job.status }}</span></td>
                            <td>
                                <button v-if="job.status === 'ACTIVE'" @click.stop="jobAction(job, 'stop')" class="btn btn-danger btn-sm py-0">åœæ­¢</button>
                                <button v-if="job.status === 'STOPPED'" @click.stop="jobAction(job, 'resume')" class="btn btn-success btn-sm py-0">æ¢å¤</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-white text-success d-flex justify-content-between">
                    <span>2. æ–‡ä»¶å¤„ç†æ˜ç»† <span v-if="selectedJob">- {{ selectedJob.name }}</span></span>
                    <button v-if="selectedJob" class="btn btn-sm btn-light" @click="fetchDetails(selectedJob.id)">ğŸ”„</button>
                </div>
                <div class="card-body p-0" v-if="selectedJob">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                        <tr><th>ID</th><th>æºæ–‡ä»¶å</th><th>çŠ¶æ€</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                        <tr v-for="d in details" :key="d.id">
                            <td>{{ d.id }}</td>
                            <td>{{ d.fileName }}</td>
                            <td><span :class="getStatusClass(d.status)">{{ d.status }}</span></td>
                            <td class="small text-muted">{{ formatTime(d.updateTime) }}</td>
                            <td>
                                <button @click="openSplits(d)" class="btn btn-outline-primary btn-sm">æŸ¥çœ‹åˆ‡ç‰‡</button>
                            </td>
                        </tr>
                        <tr v-if="details.length === 0"><td colspan="5" class="text-center text-muted p-3">æš‚æ— æ–‡ä»¶</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-body text-center text-muted p-5" v-else>ğŸ‘ˆ è¯·é€‰æ‹©ä¸€ä¸ªä½œä¸š</div>
            </div>
        </div>
    </div>

    <div v-if="showCreateJobModal" class="modal-overlay" @click.self="showCreateJobModal = false">
        <div class="modal-card-sm p-4">
            <h4 class="mb-3">âœ¨ æ–°å»ºè¿ç§»ä½œä¸š</h4>
            <form @submit.prevent="submitCreateJob">
                <div class="mb-3">
                    <label class="form-label">ä½œä¸šåç§°</label>
                    <input v-model="newJob.name" type="text" class="form-control" placeholder="ä¾‹å¦‚ï¼š2023å¹´è´¢åŠ¡æ•°æ®å½’æ¡£" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">ç›‘æ§æºç›®å½• (Source Directory)</label>
                    <input v-model="newJob.sourceDirectory" type="text" class="form-control" placeholder="/data/incoming/csv_files" required>
                    <div class="form-text">ç³»ç»Ÿå°†è‡ªåŠ¨æ‰«æè¯¥ç›®å½•ä¸‹çš„ .csv æ–‡ä»¶</div>
                </div>

                <hr>
                <h6 class="text-muted">ç›®æ ‡æ•°æ®åº“é…ç½® (Target DB)</h6>

                <div class="mb-2">
                    <label class="form-label small">JDBC URL</label>
                    <input v-model="newJob.targetDbUrl" type="text" class="form-control form-control-sm" placeholder="jdbc:mysql://192.168.1.10:3306/target_db">
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label small">ç”¨æˆ·å</label>
                        <input v-model="newJob.targetDbUser" type="text" class="form-control form-control-sm" placeholder="root">
                    </div>
                    <div class="col">
                        <label class="form-label small">å¯†ç </label>
                        <input v-model="newJob.targetDbPass" type="password" class="form-control form-control-sm">
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" @click="showCreateJobModal = false">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ç«‹å³åˆ›å»ºå¹¶å¯åŠ¨</button>
                </div>
            </form>
        </div>
    </div>

    <div v-if="showSplitModal" class="modal-overlay" @click.self="closeSplits">
        <div class="card modal-card-lg">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">åˆ‡ç‰‡ç›‘æ§ - {{ selectedDetail?.fileName }}</h5>
                <button class="btn-close" @click="closeSplits"></button>
            </div>
            <div class="card-body modal-body-scroll p-0">
                <table class="table table-striped mb-0">
                    <thead class="table-light sticky-top">
                    <tr><th>ID</th><th>åˆ‡ç‰‡å</th><th>çŠ¶æ€</th><th>é”™è¯¯ä¿¡æ¯</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody>
                    <tr v-for="s in splits" :key="s.id">
                        <td>{{ s.id }}</td>
                        <td>{{ s.splitFileName }}</td>
                        <td><span :class="getStatusClass(s.status)">{{ s.status }}</span></td>
                        <td class="text-danger small">{{ s.errorMsg }}</td>
                        <td>
                            <button v-if="canRetry(s.status)" @click="retrySplit(s)" class="btn btn-warning btn-sm">â™»ï¸ é‡è¯•</button>
                            <span v-else-if="s.status === 'PASS'" class="text-success small">âœ”</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, onMounted, onUnmounted } = Vue;
    const API_BASE = 'http://localhost:8080/api/migration';

    createApp({
        setup() {
            // æ•°æ®æº
            const jobs = ref([]);
            const details = ref([]);
            const splits = ref([]);

            // é€‰ä¸­çŠ¶æ€
            const selectedJob = ref(null);
            const selectedDetail = ref(null);

            // Modal å¼€å…³
            const showSplitModal = ref(false);
            const showCreateJobModal = ref(false);

            // æ–°å»ºä½œä¸šè¡¨å•æ•°æ®
            const newJob = reactive({
                name: '',
                sourceDirectory: '',
                targetDbUrl: 'jdbc:mysql://localhost:3306/mydb',
                targetDbUser: 'root',
                targetDbPass: ''
            });

            // è‡ªåŠ¨åˆ·æ–°é€»è¾‘
            const autoRefresh = ref(true);
            let timer = null;

            // --- API æ–¹æ³• ---
            const fetchJobs = async () => {
                try {
                    const res = await axios.get(`${API_BASE}/jobs`);
                    jobs.value = res.data;
                } catch(e) { console.error(e); }
            };

            const fetchDetails = async (jobId) => {
                try {
                    const res = await axios.get(`${API_BASE}/job/${jobId}/details`);
                    details.value = res.data;
                } catch(e) { console.error(e); }
            };

            const fetchSplits = async (detailId) => {
                try {
                    const res = await axios.get(`${API_BASE}/detail/${detailId}/splits`);
                    splits.value = res.data;
                } catch(e) { console.error(e); }
            };

            // --- äº¤äº’åŠ¨ä½œ ---

            // 1. æ–°å»ºä½œä¸š
            const openCreateModal = () => {
                // é‡ç½®è¡¨å•æˆ–ä¿æŒé»˜è®¤å€¼
                newJob.name = '';
                newJob.sourceDirectory = '';
                showCreateJobModal.value = true;
            };

            const submitCreateJob = async () => {
                try {
                    await axios.post(`${API_BASE}/job/create`, newJob);
                    alert("åˆ›å»ºæˆåŠŸï¼");
                    showCreateJobModal.value = false;
                    fetchJobs(); // åˆ·æ–°åˆ—è¡¨
                } catch (e) {
                    alert("åˆ›å»ºå¤±è´¥: " + (e.response?.data || e.message));
                }
            };

            // 2. é€‰æ‹©ä½œä¸š
            const selectJob = (job) => {
                selectedJob.value = job;
                details.value = [];
                fetchDetails(job.id);
            };

            // 3. æ‰“å¼€åˆ‡ç‰‡
            const openSplits = (detail) => {
                selectedDetail.value = detail;
                showSplitModal.value = true;
                fetchSplits(detail.id);
            };

            const closeSplits = () => showSplitModal.value = false;

            // 4. åœæ­¢/æ¢å¤
            const jobAction = async (job, action) => {
                if(!confirm(`ç¡®è®¤ ${action} ?`)) return;
                await axios.post(`${API_BASE}/job/${job.id}/action?action=${action}`);
                fetchJobs();
            };

            // 5. é‡è¯•åˆ‡ç‰‡
            const retrySplit = async (split) => {
                await axios.post(`${API_BASE}/split/${split.id}/retry`);
                split.status = 'WAIT_LOAD'; // ä¹è§‚æ›´æ–°
            };

            // --- å·¥å…· ---
            const toggleAutoRefresh = () => autoRefresh.value = !autoRefresh.value;
            const canRetry = (s) => ['FAIL_LOAD', 'FAIL_VERIFY', 'FAIL_TRANSCODE'].includes(s);
            const formatTime = (t) => t ? t.replace('T', ' ').substring(0, 19) : '';
            const getStatusClass = (s) => {
                const map = {
                    'ACTIVE': 'badge bg-primary', 'STOPPED': 'badge bg-secondary',
                    'NEW': 'badge bg-secondary', 'TRANSCODING': 'badge bg-warning text-dark',
                    'PROCESSING_CHILDS': 'badge bg-primary', 'FINISHED': 'badge bg-success',
                    'FINISHED_WITH_ERROR': 'badge bg-danger', 'WAIT_LOAD': 'badge bg-secondary',
                    'LOADING': 'badge bg-info text-dark', 'FAIL_LOAD': 'badge bg-danger',
                    'WAIT_VERIFY': 'badge bg-warning text-dark', 'PASS': 'badge bg-success',
                    'FAIL_VERIFY': 'badge bg-danger'
                };
                return map[s] || 'badge bg-light text-dark';
            };

            // --- ç”Ÿå‘½å‘¨æœŸ ---
            onMounted(() => {
                fetchJobs();
                timer = setInterval(() => {
                    if(autoRefresh.value) {
                        fetchJobs();
                        if(selectedJob.value) fetchDetails(selectedJob.value.id);
                        if(showSplitModal.value && selectedDetail.value) fetchSplits(selectedDetail.value.id);
                    }
                }, 3000);
            });

            onUnmounted(() => clearInterval(timer));

            return {
                jobs, details, splits, selectedJob, selectedDetail,
                showSplitModal, showCreateJobModal, newJob, autoRefresh,
                fetchDetails, openCreateModal, submitCreateJob, selectJob,
                openSplits, closeSplits, jobAction, retrySplit, toggleAutoRefresh,
                canRetry, formatTime, getStatusClass
            };
        }
    }).mount('#app');
</script>
</body>
</html>