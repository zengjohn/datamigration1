## å†’çƒŸæµ‹è¯•ç®€å•æµç¨‹



`Jdk21`



### `application.yml`é…ç½®

#### ä¿®æ”¹ç›‘å¬ç«¯å£

â€‹	`server.port`



#### ä¿®æ”¹ç›®æ ‡æ•°æ®æº 

#### 	`spring.datasource`



#### è‡ªå®šä¹‰é…ç½®

##### 	æºç«¯`ibm csv`é…ç½®

â€‹		`app.csv.ibm-source`	

##### 	ä¸­é—´`csv`æ‹†åˆ†æ–‡ä»¶é…ç½®

â€‹		`app.csv.utf8-split`

##### 	æ€§èƒ½é…ç½®

â€‹		`app.performance`

â€‹	

##### 	çº¿ç¨‹æ± é…ç½®

###### 			è½¬ç 

â€‹			`app.migration-thread-pool.transcode`

###### 			è£…è½½

â€‹			`app.migration-thread-pool.load`

###### 			éªŒè¯	

â€‹			`app.migration-thread-pool.verify`

##### 	ç¨‹åºå·¥ä½œç›®å½•é…ç½®

â€‹		`app.job`

##### è£…è½½`jdbc`é…ç½®	

â€‹	`preSqlList`è£…è½½å‰é¢„å…ˆæ‰§è¡Œ`sql`

â€‹	`urlOptions` è£…è½½`jdbc url`é…ç½®

##### éªŒè¯

â€‹	`app.verify`		

â€‹	éªŒè¯ç­–ç•¥ `strategy`

â€‹		`USE_SOURCE_FILE`: æºæ–‡ä»¶å’Œ`tdsql`æ•°æ®è¿›è¡Œæ¯”å¯¹, `USE_UTF8_SPLIT`ç”¨æ‹†åˆ†æ–‡ä»¶å’Œ`tdsql`æ•°æ®è¿›è¡ŒéªŒè¯

â€‹	`maxDiffCount`

â€‹		æœ€å¤§å·®å¼‚è¡Œ, è¶…è¿‡åç»“æŸæ¯”å¯¹



### æ¸…ç†æ¼”ç¤ºç¯å¢ƒ

```sql
drop table if exists `test1`.`csv_split`;
drop table if exists `test1`.`qianyi_detail`;
drop table if exists `test1`.`qianyi`;
drop table if exists `test1`.`migration_job`;

drop table if exists `test2`.`test_iconv`;
drop table if exists `test2`.`test_ibm1388`;
```



### åœ¨ç›®æ ‡åº“å»ºè¡¨

è¿ç§»ç¨‹åºä¸ä¼šè‡ªåŠ¨å»ºè¡¨

```mysql
CREATE TABLE `test2`.`test_iconv` (
  `id` int(11) DEFAULT NULL,
  `name` varchar(64) DEFAULT NULL,
  `remark` varchar(32) DEFAULT NULL,
  `csvid` bigint(20) DEFAULT NULL,
  `source_row_no` bigint(20) DEFAULT NULL,
  KEY `idx_csvid_rowno` (`csvid`,`source_row_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

 CREATE TABLE `test2`.`test_ibm1388` (
  `user_id` varchar(64) DEFAULT NULL,
  `user_name` varchar(16300) DEFAULT NULL,
  `balance` decimal(10,2) DEFAULT NULL,
  `csvid` bigint(20) DEFAULT NULL,
  `source_row_no` bigint(20) DEFAULT NULL,
  KEY `idx_csvid_rowno` (`csvid`,`source_row_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```



è¯´æ˜ï¼š

1. å»ºè¡¨éœ€è¦åœ¨åŸæ¥è¡¨çš„åŸºç¡€ä¸Šæ·»åŠ 2ä¸ªå­—æ®µå’Œä¸€ä¸ªç´¢å¼•

   `csvid` ç›®æ ‡è¡Œå¯¹äºçš„æ‹†åˆ†æ–‡ä»¶(æ‹†åˆ†è¡¨`csv_split`è®°å½•id)

   `source_row_no` ç›®æ ‡è¡Œåœ¨åŸ `csv`æ–‡ä»¶ä¸­çš„è¡Œæ•°

2. å®é™…çš„åˆ†å¸ƒå¼`tdsql`ç¯å¢ƒï¼Œéœ€è¦ç»™åˆ†ç‰‡é”®ã€‚åˆ†ç‰‡é”®é€‰æ‹©ä¸è€ƒè™‘ä¸šåŠ¡åœºæ™¯ï¼Œåªè€ƒè™‘åŒæ­¥æ€§èƒ½ã€‚é€‰æ‹©`csvid`åšåˆ†ç‰‡é”®ï¼Œè¿™æ ·åŒä¸€ä¸ªæ‹†åˆ†`csv`æ–‡ä»¶æ•°æ®(`load data infile`)éƒ½åŠ è½½åˆ°åŒä¸€ä¸ªåˆ†ç‰‡ä¸­ã€‚

å®é™…çš„`tdsql`ç¯å¢ƒå»ºè¡¨è¯­å¥

```sql
CREATE TABLE `test2`.`test_iconv` (
  `id` int(11) DEFAULT NULL,
  `name` varchar(64) DEFAULT NULL,
  `remark` varchar(32) DEFAULT NULL,
  `csvid` bigint(20) DEFAULT NULL,
  `source_row_no` bigint(20) DEFAULT NULL,
  KEY `idx_csvid_rowno` (`csvid`,`source_row_no`)
) shardkey=`csvid` ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```



### ç•Œé¢æ–°åŠ è¿ç§»ä½œä¸š

ç™»å½•ï¼šhttp://localhost:8080/



#### æ–°å»ºè¿ç§»ä½œä¸š

```
ä½œä¸šåç§°ï¼šç”¨æˆ·è¡¨è¿ç§»
ç›‘æ§ç›®å½•: /root/mig1/test_data
è¾“å‡ºç›®å½•: /root/mig1/out_dir
ç›®æ ‡æ•°æ®åº“URLï¼š jdbc:mysql://192.168.37.101:3306/test2
```



è¯´æ˜ï¼šæŒ‰æ¯ä¸ªåˆ†ç‰‡å»ºè¿ç§»ä½œä¸šï¼Œæ¯ä¸ªåˆ†ç‰‡çš„ä½œä¸šç›‘æ§ç›®æ ‡ä¸ä¸€æ ·(ä¹Ÿè¡Œåœ¨ä¸åŒçš„è¿ç§»æœºå™¨ä¸Š)



#### åˆ›å»ºè¿ç§»è¯·æ±‚

ä¸Šä¼ `csv`æ–‡ä»¶åˆ°è¿ç§»ç›®å½•

1) ä¸Šä¼  `test_iconv.csv` åˆ°è¿ç§»æœºå™¨

2) ä¸Šä¼  è¡¨ç»“æ„å®šä¹‰æ–‡ä»¶ `test_iconv.sql` åˆ°è¿ç§»æœºå™¨

   ç¤ºä¾‹è¡¨ç»“æ„æ–‡ä»¶ `test_iconv.sql`

   æ–‡æœ¬æ ¼å¼ï¼Œæ¯ä¸€è¡Œæ˜¯è¡¨çš„åˆ—åå’Œç±»å‹ï¼Œç›®å‰åªç”¨åˆ°åˆ—å

   ```
   id,number
   name,varchar
   remark,varchar
   ```

   

3) ä¸Šä¼ `ok`æ–‡ä»¶ `test_iconv.ok`

   ç¤ºä¾‹`test_iconv.ok`æ–‡ä»¶

   ```json
   {
     "ddl": "/root/mig1/test_data/test_iconv.sql",
     "csv": [
         "/root/mig1/test_data/test_iconv.csv",
     ]
   }
   ```
   
   æ–‡ä»¶æ ¼å¼è¯´æ˜ï¼Œ `json`æ ¼å¼
   

`ddl`æŒ‡å®šè¡¨ç»“æ„å®šä¹‰æ–‡ä»¶ï¼ˆå…¨è·¯å¾„)

`csv`å®šä¹‰æ•°æ®æ–‡ä»¶å…¨è·¯å¾„ï¼ˆå¯ä»¥æœ‰å¤šä¸ªï¼‰



`ok`æ–‡ä»¶ä¸Šä¼ åï¼Œè¿ç§»è‡ªåŠ¨å¼€å§‹



å¯ä»¥ç»§ç»­ä¸Šä¼ å…¶ä»–è¿ç§»è¯·æ±‚

æ¯”å¦‚ä¸Šä¼ `csv`æ–‡ä»¶   `test_ibm1388.csv` , ä¸Šä¼ è¡¨ç»“æ„å®šä¹‰ `test_ibm1388.sql`, ç„¶åä¸Šä¼ `ok`æ–‡ä»¶ `test_ibm1388.ok`

`test_ibm1388.sql`

```
user_id,number
user_name,varchar
balance,decimal
```



`test_ibm1388.ok`

```json
{
  "ddl": "/root/mig1/test_data/test_ibm1388.sql",
  "csv": [
      "/root/mig1/test_data/test_ibm1388.csv",
  ]
}
```





#### ç›‘çœ‹è¿ç§»è¿‡ç¨‹

åœ¨ç•Œé¢æŸ¥çœ‹è¿ç§»è¿‡ç¨‹



### å¤§æœº`CSV`æ–‡ä»¶æ ¼å¼é…ç½®

è§£æ **`IBM1388 (EBCDIC ç®€ä½“ä¸­æ–‡)`** æ ¼å¼çš„å¤§æœº `CSV` æ–‡ä»¶ï¼Œä½¿ç”¨ `univocity-parsers` æ—¶ï¼Œæ ¸å¿ƒç—›ç‚¹é€šå¸¸åœ¨äº**ç¼–ç å…¼å®¹æ€§**ã€**ç‰¹æ®Šæ§åˆ¶ç¬¦**ä»¥åŠ**ä¸å®šé•¿å­—æ®µçš„ç¼“å†²åŒºæº¢å‡º**ï¼Œ ä»¥ä¸‹æ˜¯éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é…ç½®ã€‚é…ç½®æ–‡ä»¶ `application.yml`,  `app.csv.ibm-source`ã€‚

```yaml
app:
  csv:
    ibm-source:
      # ã€æ ¸å¿ƒ 1ã€‘ç¼–ç è®¾ç½®
      # å¿…é¡»ä½¿ç”¨ ICU4J æ”¯æŒçš„æ ‡å‡†åç§°ã€‚JDK åŸç”Ÿå¯èƒ½å« "IBM1388"ï¼Œä½† ICU å¸¸ç”¨ "x-IBM1388" æˆ– "cp1388"
      # å¦‚æœæ‚¨çš„ç¯å¢ƒé‡Œæœ‰ç”Ÿåƒ»å­—é—®é¢˜ï¼Œç¡®ä¿ pom.xml å¼•å…¥äº† icu4j-charset
      encoding: IBM1388

      # ã€æ ¸å¿ƒ 2ã€‘ç”Ÿåƒ»å­—/è½¬ä¹‰æ”¯æŒ
      # å¯¹åº”æ‚¨ä»£ç  TranscodeService ä¸­çš„é€»è¾‘ã€‚
      # å¦‚æœå¤§æœºç”Ÿæˆæ–‡ä»¶æ—¶ï¼Œå°†æ— æ³•æ˜¾ç¤ºçš„å­—è½¬ä¹‰æˆäº† \ABC\ æ ¼å¼ï¼Œè¿™é‡Œå¿…é¡»å¼€å¯ï¼Œå¦åˆ™ä¼šåŸæ ·è¯»å‡ºã€‚
      tunneling: true

      # ã€æ ¸å¿ƒ 3ã€‘ç¼“å†²åŒºé˜²å¾¡
      # å¤§æœºå¯¼å‡ºçš„ CSV æœ‰æ—¶æŸä¸ªå¤‡æ³¨å­—æ®µç‰¹åˆ«é•¿ï¼ˆä¾‹å¦‚ COBOL å®šä¹‰äº† PIC X(20000)ï¼‰
      # é»˜è®¤çš„ 4096 å¾ˆå®¹æ˜“æŠ¥ TextParsingExceptionï¼Œå»ºè®®ç»™åˆ° 50000 æˆ–æ›´å¤§
      max-chars-per-column: 50000

      # ã€æ ¸å¿ƒ 4ã€‘æ¢è¡Œç¬¦
      # æ¨è "AUTO"ã€‚å¤§æœºæ–‡ä»¶ç»è¿‡ FTP ä¼ è¾“åˆ° Linux/Windows åï¼Œæ¢è¡Œç¬¦å¯èƒ½æ˜¯ \n ä¹Ÿå¯èƒ½æ˜¯ \r\nã€‚
      # Univocity çš„è‡ªåŠ¨æ£€æµ‹éå¸¸å‡†ï¼Œç¡¬ç¼–ç åè€Œå®¹æ˜“é”™ã€‚
      line-separator: "AUTO"

      # ã€ç»†èŠ‚ 1ã€‘å»ç©ºæ ¼
      # å¤§æœºå­—æ®µå¸¸å¸¦æœ‰å®šé•¿è¡¥ç©ºçš„ç©ºæ ¼ï¼ˆPaddingï¼‰ï¼Œè¯»å–æ—¶å»ºè®®è‡ªåŠ¨å»é™¤
      ignore-leading-whitespaces: true
      ignore-trailing-whitespaces: true

      # ã€ç»†èŠ‚ 2ã€‘ç©ºå€¼å¤„ç†
      # å¦‚æœ CSV é‡Œå†™çš„æ˜¯ "null" å­—ç¬¦ä¸²æˆ–ç©ºä¸²ï¼Œè½¬æ¢æˆçœŸæ­£çš„ Java null
      null-value: ""

      # ã€ç»†èŠ‚ 3ã€‘åˆ†éš”ç¬¦
      # æ ‡å‡†æ˜¯é€—å·ã€‚ä½†å¦‚æœå¤§æœºæ•°æ®é‡ŒåŒ…å«é€—å·ä¸”æ²¡æœ‰æ­£ç¡®è½¬ä¹‰ï¼Œå¯ä»¥è€ƒè™‘åœ¨å¤§æœºç«¯æ”¹ç”¨ç”Ÿåƒ»å­—ç¬¦ï¼ˆå¦‚ | æˆ– \tï¼‰åšåˆ†éš”
      delimiter: ","
      quote: "\""
      quote-escape: "\""
```



#### é…ç½®é¡¹æ·±åº¦è§£æ

##### 1. `encoding: "x-IBM1388"`

- **èƒŒæ™¯**ï¼šJava åŸç”Ÿçš„ `IBM1388` æ”¯æŒå¯èƒ½ä¸å…¨ï¼Œæˆ–è€…åœ¨æŸäº› JDK ç‰ˆæœ¬ï¼ˆå¦‚ OpenJDKï¼‰ä¸­ç¼ºå¤±ã€‚æ‚¨çš„é¡¹ç›®å¼•å…¥äº† `icu4j`ï¼Œä½¿ç”¨ `x-IBM1388` æ˜¯è°ƒç”¨ ICU åº“æœ€ç¨³å¦¥çš„æ–¹å¼ã€‚
- **æ³¨æ„**ï¼šç¡®ä¿ `CharsetFactory.java` ä¸­çš„é€»è¾‘èƒ½ä¼˜å…ˆåŠ è½½ `JDK`ï¼Œå¤±è´¥åå›é€€åˆ° ICUï¼Œæˆ–è€…ç›´æ¥æŒ‡å®šç”± ICU åŠ è½½ã€‚

##### 2. `tunneling: true`

- **èƒŒæ™¯**ï¼š`IBM1388` å­—ç¬¦é›†æ¯” `GBK/UTF-8` å°ï¼Œå¾ˆå¤šç”Ÿåƒ»å­—ï¼ˆå¦‚â€œğ¬±–â€ï¼‰åœ¨å¤§æœºä¸Šæ— æ³•ç›´æ¥å­˜å‚¨æˆ–æ˜¾ç¤ºã€‚
- **é…åˆ**ï¼šè¿™ä¸ªé…ç½®å¼€å…³å¯¹åº”æ‚¨ `TranscodeService.java` ä¸­çš„é€»è¾‘ã€‚å¼€å¯åï¼Œç¨‹åºä¼šè°ƒç”¨ `FastEscapeHandler.unescape()`ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶è¿˜åŸç±»ä¼¼ `\2CC56\` è¿™æ ·çš„ Hex è½¬ä¹‰åºåˆ—ï¼Œå°†å…¶å˜ä¸ºçœŸæ­£çš„ UTF-8 å­—ç¬¦å…¥åº“ã€‚å¦‚æœä¸å¼€å¯ï¼Œè¿™äº›å­—å°±ä¼šå˜æˆä¹±ç æˆ–åŸå§‹çš„è½¬ä¹‰ä¸²ã€‚

##### 3. `max-chars-per-column: 50000`

- **ç—›ç‚¹**ï¼š`univocity-parsers` ä¸ºäº†æé€Ÿæ€§èƒ½ï¼Œé»˜è®¤å¤ç”¨ä¸€ä¸ªè¾ƒå°çš„ `char[]` ç¼“å†²åŒºï¼ˆé»˜è®¤ 4096ï¼‰ã€‚
- **é£é™©**ï¼šå¤§æœºæ•°æ®å¯¼å‡ºæ—¶ï¼Œå¸¸å¸¸åŒ…å«å·¨å¤§çš„ XML æŠ¥æ–‡æˆ– Base64 å­—ç¬¦ä¸²ä½œä¸ºå•ä¸€å­—æ®µã€‚ä¸€æ—¦è¶…è¿‡é™åˆ¶ï¼Œç¨‹åºä¼šç›´æ¥æŠ›å‡º `TextParsingException` å¯¼è‡´ä»»åŠ¡ä¸­æ–­ã€‚å»ºè®®è®¾ä¸ºä¸šåŠ¡æœ€å¤§å­—æ®µé•¿åº¦çš„ 1.5 å€ã€‚

##### 4. `line-separator: "AUTO"`

- **åŸç†**ï¼šUnivocity ä¼šè¯»å–æ–‡ä»¶å‰ 4KB æ•°æ®ï¼Œåˆ†æ `\r` å’Œ `\n` çš„åˆ†å¸ƒæ¥è‡ªåŠ¨å†³å®šæ¢è¡Œç¬¦ã€‚
- **ä¼˜åŠ¿**ï¼šè¿™è®©æ‚¨çš„ç¨‹åºèƒ½åŒæ—¶å…¼å®¹ä» FTP (Binaryæ¨¡å¼) ä¸‹æ¥çš„åŸå§‹æ–‡ä»¶å’Œ FTP (ASCIIæ¨¡å¼) è½¬æ¢è¿‡çš„æ–‡ä»¶ï¼Œæ— éœ€è¿ç»´äººå‘˜æ‰‹åŠ¨æ”¹é…ç½®ã€‚



### æµ‹è¯•æ–‡ä»¶äº§ç”Ÿ

#### ç”¨`iconv`äº§ç”Ÿ

`test_iconv.csv`

å…ˆåˆ›å»ºä¸€ä¸ªæ™®é€šçš„ `UTF-8 æ–‡ä»¶` `source.csv`

```
1,å¼ ä¸‰,Testing
```

æ‰§è¡Œè½¬æ¢å‘½ä»¤

```bash
$ iconv -f UTF-8 -t IBM1388 source.csv -o test_iconv.csv
```



#### ç”¨icu4jåº“äº§ç”Ÿ

`test_ibm1388.csv`

```java
package com.example.moveprog;

import java.io.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Random;

public class TestDataGenerator {
    // åŸºç¡€é…ç½®
    private static final String OUT_DIR = "testdata";
    // æ‚¨çš„é¡¹ç›®ä½¿ç”¨çš„æ˜¯ ICU4J çš„ x-IBM1388
    private static final String CHARSET_IBM = "x-IBM1388";
    private static final String CHARSET_UTF8 = "UTF-8";

    public static void main(String[] args) throws Exception {
        try {
            Files.createDirectories(Paths.get(OUT_DIR));
            System.out.println(">>> å¼€å§‹ç”Ÿæˆæµ‹è¯•æ•°æ®ï¼Œè¾“å‡ºç›®å½•: " + OUT_DIR);

            generateBasic();
            generateCategoryA_Basic();
            generateCategoryB_CsvFormat();
            generateCategoryC_BusinessRules();
            generateCategoryD_Performance(100_000); // ç”Ÿæˆ10ä¸‡è¡Œåšæ¼”ç¤ºï¼Œå¯æ”¹ä¸º 10_000_000
            generateCategoryE_Exceptions();
            generateCategoryF_Tunneling(); // ã€æ–°å¢ã€‘é’ˆå¯¹ FastEscapeHandler

            System.out.println(">>> æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ç”Ÿæˆå®Œæ¯•ï¼");

        } catch (Exception e) {
            e.printStackTrace();
            System.err.println("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å¼•å…¥äº† icu4j ä¾èµ–");
        }
    }

    private static void generateBasic() throws IOException {
        String filename = OUT_DIR + "/test_ibm1388.csv";
        // 1. æ¨¡æ‹Ÿæ•°æ®ï¼šåŒ…å«æ™®é€šä¸­æ–‡ã€è‹±æ–‡ã€ä»¥åŠ"ç”Ÿåƒ»å­—è½¬ä¹‰ç¬¦"(æµ‹è¯• Tunneling åŠŸèƒ½)
        // å¯¹åº” FastEscapeHandler çš„é€»è¾‘: \2CC56\ ä¼šè¢«è¿˜åŸ
        String content = "user_id,user_name,balance\n" +
                "1001,å¼ ä¸‰,100.00\n" +
                "1002,æå››_æ™®é€š,200.50\n" +
                "1003,ç‹\\2CC56\\äº”,888.88"; // æµ‹è¯•è½¬ä¹‰: \2CC56\

        writeWithEncoding(filename, content, CHARSET_IBM);
        System.out.println("[A] åŸºç¡€ç¼–ç æ–‡ä»¶ç”Ÿæˆ: " + filename);
    }

    // ==========================================
    // A. åŸºç¡€ä¸ç¼–ç éªŒè¯
    // ==========================================
    private static void generateCategoryA_Basic() throws IOException {
        String filename = OUT_DIR + "/A_Basic_Encoding.csv";
        // åŒ…å«ï¼šè‹±æ–‡ã€æ™®é€šä¸­æ–‡ã€æ•°å­—
        StringBuilder sb = new StringBuilder();
        sb.append("user_id,user_name,balance\n");
        sb.append("A001,John Doe,100.00\n");
        sb.append("A002,å¼ ä¸‰_æµ‹è¯•,200.50\n");
        sb.append("A003,æå››_End,999.99");

        writeWithEncoding(filename, sb.toString(), CHARSET_IBM);
        System.out.println("[A] åŸºç¡€ç¼–ç æ–‡ä»¶ç”Ÿæˆ: " + filename);
    }

    // ==========================================
    // B. æ•°æ®æ ¼å¼è¾¹ç•ŒéªŒè¯ (CSV è§£æå¥å£®æ€§)
    // ==========================================
    private static void generateCategoryB_CsvFormat() throws IOException {
        String filename = OUT_DIR + "/B_Csv_Format_Edge.csv";
        StringBuilder sb = new StringBuilder();
        sb.append("user_id,user_name,balance\n");

        // 1. å­—æ®µå«åˆ†éš”ç¬¦ (éœ€å¼•å·åŒ…è£¹)
        sb.append("B001,\"Doe, John\",100.00\n");

        // 2. å­—æ®µå«æ¢è¡Œç¬¦ (Univocity éœ€æ”¯æŒå¤šè¡Œæ¨¡å¼)
        sb.append("B002,\"å¼ ä¸‰\næ¢è¡Œæµ‹è¯•\",200.00\n");

        // 3. å­—æ®µå«å¼•å· (éœ€åŒé‡è½¬ä¹‰) -> å®é™…æ˜¾ç¤ºä¸º: ç‹"äº”"
        sb.append("B003,\"ç‹\"\"äº”\"\"\",300.00\n");

        // 4. ç©ºå­—æ®µä¸ç©ºè¡Œ
        sb.append("B004,,0.00\n"); // user_name ä¸ºç©º
        sb.append(",,\n");         // å…¨ç©ºè¡Œ

        // 5. è¶…é•¿å­—æ®µ (15KB å­—ç¬¦ä¸²)
        String longText = generateRandomString(15000);
        sb.append("B005,\"Long_Start_").append(longText).append("_End\",500.00\n");

        writeWithEncoding(filename, sb.toString(), CHARSET_IBM);
        System.out.println("[B] CSVæ ¼å¼è¾¹ç•Œæ–‡ä»¶ç”Ÿæˆ: " + filename);
    }

    // ==========================================
    // C. ä¸šåŠ¡è§„åˆ™è¾¹ç•ŒéªŒè¯
    // ==========================================
    private static void generateCategoryC_BusinessRules() throws IOException {
        String filename = OUT_DIR + "/C_Business_Rules.csv";
        StringBuilder sb = new StringBuilder();
        sb.append("user_id,user_name,balance\n");

        // 1. é‡‘é¢æå€¼
        sb.append("C001,Max_Value,9999999999.99\n");
        sb.append("C002,Min_Value,-9999999999.99\n");
        sb.append("C003,High_Precision,0.123456789\n"); // çœ‹çœ‹æ•°æ®åº“ Decimal(10,2) æ˜¯å¦æŠ¥é”™æˆ–æˆªæ–­

        // 2. ç©ºæ ¼æ•æ„Ÿ (å‰å¯¼/åå¯¼ç©ºæ ¼)
        sb.append("C004,  Space_Test  ,100.00\n");

        // 3. ç‰¹æ®ŠID
        sb.append("0000,Zero_ID,0\n");

        writeWithEncoding(filename, sb.toString(), CHARSET_IBM);
        System.out.println("[C] ä¸šåŠ¡è§„åˆ™æ–‡ä»¶ç”Ÿæˆ: " + filename);
    }

    // ==========================================
    // D. æ‰¹é‡ä¸æ€§èƒ½éªŒè¯
    // ==========================================
    private static void generateCategoryD_Performance(int rows) throws IOException {
        String filename = OUT_DIR + "/D_Performance_" + rows + ".csv";
        // ä½¿ç”¨ BufferedWriter é¿å…å†…å­˜æº¢å‡º
        try (BufferedWriter writer = new BufferedWriter(
                new OutputStreamWriter(new FileOutputStream(filename), CHARSET_IBM))) {

            writer.write("user_id,user_name,balance\n");
            Random rand = new Random();

            for (int i = 0; i < rows; i++) {
                // æ¨¡æ‹ŸçœŸå®åˆ†å¸ƒï¼šå¤§éƒ¨åˆ†æ˜¯çŸ­æ•°æ®ï¼Œå¶å°”æœ‰é•¿æ•°æ®
                String name = (i % 100 == 0) ? "Name_" + generateRandomString(500) : "User_" + i;
                String line = String.format("D%07d,%s,%.2f\n", i, name, rand.nextDouble() * 10000);
                writer.write(line);
            }
        }
        System.out.println("[D] æ€§èƒ½æµ‹è¯•æ–‡ä»¶ç”Ÿæˆ (" + rows + "è¡Œ): " + filename);
    }

    // ==========================================
    // E. å¼‚å¸¸ä¸å®¹é”™éªŒè¯ (äºŒè¿›åˆ¶ç ´å)
    // ==========================================
    private static void generateCategoryE_Exceptions() throws IOException {
        // E1. é”™è¯¯ç¼–ç æ··æ‚ (IBM1388 ä¸­æ··å…¥ UTF-8)
        File f1 = new File(OUT_DIR + "/E1_Mixed_Encoding.csv");
        try (FileOutputStream fos = new FileOutputStream(f1)) {
            fos.write("user_id,user_name,balance\n".getBytes(CHARSET_IBM));
            fos.write("E001,æ­£å¸¸IBM1388,100\n".getBytes(CHARSET_IBM));
            fos.write("E002,æˆ‘æ˜¯UTF8ä¹±å…¥,200\n".getBytes(CHARSET_UTF8)); // è¿™é‡Œä¼šäº§ç”Ÿä¹±ç 
            fos.write("E003,æ­£å¸¸IBM1388,300\n".getBytes(CHARSET_IBM));
        }

        // E2. é”™è¯¯å¼•å· (Unclosed Quote) - å¯¼è‡´è§£æå™¨åæ‰åç»­æ‰€æœ‰è¡Œ
        String f2 = OUT_DIR + "/E2_Unclosed_Quote.csv";
        StringBuilder sb = new StringBuilder();
        sb.append("user_id,user_name,balance\n");
        sb.append("E004,\"Unclosed Quote Start,100.00\n"); // ç¼ºå³å¼•å·
        sb.append("E005,Should_Be_Swallowed,200.00\n");
        writeWithEncoding(f2, sb.toString(), CHARSET_IBM);

        // E3. æ–‡ä»¶æˆªæ–­ (å†™å…¥ä¸€åŠçªç„¶ç»“æŸ)
        File f3 = new File(OUT_DIR + "/E3_Truncated.csv");
        try (FileOutputStream fos = new FileOutputStream(f3)) {
            fos.write("user_id,user_name,bal".getBytes(CHARSET_IBM)); // Headeréƒ½æ²¡å†™å®Œ
        }

        System.out.println("[E] å¼‚å¸¸å®¹é”™æ–‡ä»¶ç”Ÿæˆ: E1, E2, E3");
    }

    // ==========================================
    // F. [æ–°å¢] è½¬ä¹‰ç©¿é€ (Tunneling) éªŒè¯
    // ==========================================
    private static void generateCategoryF_Tunneling() throws IOException {
        String filename = OUT_DIR + "/F_Tunneling_Handler.csv";
        StringBuilder sb = new StringBuilder();
        sb.append("user_id,user_name,balance\n");

        // 1. æ ‡å‡†ç”Ÿåƒ»å­—è½¬ä¹‰ (å‡è®¾ \2CC56\ ä»£è¡¨ä¸€ä¸ªç”Ÿåƒ»å­—)
        // æœŸæœ›ï¼šå…¥åº“åä¸å†åŒ…å« \2CC56\ï¼Œè€Œæ˜¯å¯¹åº”çš„ Unicode å­—ç¬¦(å¦‚æœè½¬æ¢æ”¯æŒ) æˆ– ä¿æŒåŸæ ·(å–å†³äºé…ç½®)
        sb.append("F001,å¼ \\2CC56\\ä¸‰,100.00\n");

        // 2. è¿ç»­è½¬ä¹‰
        sb.append("F002,A\\2CC56\\B\\2CC57\\C,200.00\n");

        // 3. å‡è½¬ä¹‰ (æ ¼å¼ä¸å¯¹ï¼ŒFastEscapeHandler åº”è¯¥å¿½ç•¥)
        sb.append("F003,æ™®é€šæ–œæ \\ABC,300.00\n");

        // 4. è¾¹ç•Œæƒ…å†µï¼šè¡Œå°¾è½¬ä¹‰ä¸é—­åˆ
        sb.append("F004,æœªé—­åˆ\\2CC56,400.00\n");

        writeWithEncoding(filename, sb.toString(), CHARSET_IBM);
        System.out.println("[F] è½¬ä¹‰ç©¿é€æµ‹è¯•æ–‡ä»¶ç”Ÿæˆ: " + filename);
    }

    // --- å·¥å…·æ–¹æ³• ---
    private static void writeWithEncoding(String path, String content, String encoding) throws IOException {
        File file = new File(path);
        try (BufferedWriter writer = new BufferedWriter(
                new OutputStreamWriter(new FileOutputStream(file), encoding))) {
            writer.write(content);
            System.out.println("ç”ŸæˆæˆåŠŸ: " + path);
            System.out.println("æ–‡ä»¶å¤§å°: " + file.length() + " å­—èŠ‚");
        }
    }

    private static String generateRandomString(int length) {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        StringBuilder sb = new StringBuilder(length);
        Random random = new Random();
        for (int i = 0; i < length; i++) {
            sb.append(chars.charAt(random.nextInt(chars.length())));
        }
        return sb.toString();
    }

}
```



### ç¯å¢ƒä¼˜åŒ–

è¯´æ˜ï¼šä¸‹é¢çš„é…ç½®æ²¡æœ‰éªŒè¯ï¼Œä»…ä¾›å‚è€ƒ



#### æ•°æ®åº“é…ç½®ä¼˜åŒ–



##### å¯åŠ¨ä¼˜åŒ–ä¼šè¯ï¼ˆéœ€è¦SUPERæƒé™ï¼‰

```
SET GLOBAL innodb_buffer_pool_size = 17179869184;  -- 16GBï¼Œæ ¹æ®å†…å­˜è°ƒæ•´
SET GLOBAL innodb_log_file_size = 4294967296;      -- 4GB
SET GLOBAL innodb_log_buffer_size = 268435456;     -- 256MB
SET GLOBAL innodb_flush_log_at_trx_commit = 2;     -- é™ä½åˆ·ç›˜é¢‘ç‡
SET GLOBAL sync_binlog = 0;                        -- å…³é—­binlogåŒæ­¥
SET GLOBAL max_allowed_packet = 1073741824;        -- 1GB
SET GLOBAL net_buffer_length = 16777216;           -- 16MB
SET GLOBAL bulk_insert_buffer_size = 536870912;    -- 512MB
SET GLOBAL innodb_io_capacity = 4000;              -- SSDå»ºè®®å€¼
SET GLOBAL innodb_io_capacity_max = 8000;
SET GLOBAL innodb_read_io_threads = 8;
SET GLOBAL innodb_write_io_threads = 8;
SET GLOBAL innodb_purge_threads = 4;
SET GLOBAL innodb_page_cleaners = 4;
SET GLOBAL innodb_adaptive_flushing = ON;
SET GLOBAL innodb_flush_neighbors = 0;             -- SSDå»ºè®®å…³é—­
SET GLOBAL innodb_doublewrite = 0;                 -- ä»…æ‰¹é‡åŠ è½½æ—¶å…³é—­
SET GLOBAL innodb_checksum_algorithm = none;       -- å…³é—­æ ¡éªŒ
SET GLOBAL innodb_log_compressed_pages = OFF;      -- å‡å°‘æ—¥å¿—å¤§å°
SET GLOBAL thread_pool_size = 32;                  -- æ ¹æ®CPUæ ¸å¿ƒæ•°
```

###### TDSQLç‰¹æœ‰å‚æ•°ï¼ˆå¦‚æœé€‚ç”¨ï¼‰

```
-- TDSQLåˆ†å¸ƒå¼ä¼˜åŒ–
SET GLOBAL tdsql_batch_commit_size = 1000000;
SET GLOBAL tdsql_parallel_load_threads = 8;
SET GLOBAL tdsql_skip_slave_check = 1;      -- è·³è¿‡ä»åº“æ£€æŸ¥
SET GLOBAL tdsql_load_data_memory_limit = 4294967296;  -- 4GBå†…å­˜é™åˆ¶
```



##### é…ç½®æ–‡ä»¶æ°¸ä¹…è®¾ç½®ï¼ˆmy.cnf / my.iniï¼‰

###### å†…å­˜ä¼˜åŒ–ï¼ˆæ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´ï¼‰

```
 å†…å­˜é…ç½®ï¼ˆ64GBå†…å­˜æœåŠ¡å™¨ç¤ºä¾‹ï¼‰
innodb_buffer_pool_size = 48G                    # ç³»ç»Ÿå†…å­˜çš„70-75%
innodb_buffer_pool_instances = 8                 # æ¯ä¸ªå®ä¾‹è‡³å°‘1GB
innodb_log_buffer_size = 256M
innodb_log_file_size = 4G                        # æ¯ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°
innodb_log_files_in_group = 2                    # æ€»å…±8GBæ—¥å¿—ç©ºé—´

# è¿æ¥ç›¸å…³
max_connections = 1000
max_connect_errors = 100000
connect_timeout = 60
wait_timeout = 28800
interactive_timeout = 28800
```



##### IOä¼˜åŒ–ï¼ˆSSDç¡¬ç›˜æ¨èï¼‰

```
# IOä¼˜åŒ–
innodb_flush_method = O_DIRECT                   # Linuxä½¿ç”¨O_DIRECTï¼ŒWindowsä½¿ç”¨async_unbuffered
innodb_flush_log_at_trx_commit = 2               # æ‰¹é‡åŠ è½½ä¼˜åŒ–
innodb_doublewrite = 0                           # æ‰¹é‡åŠ è½½æ—¶å…³é—­
innodb_file_per_table = ON
innodb_data_file_path = ibdata1:1G:autoextend
innodb_autoextend_increment = 128

# SSDä¼˜åŒ–
innodb_io_capacity = 4000
innodb_io_capacity_max = 8000
innodb_read_io_threads = 8
innodb_write_io_threads = 8
innodb_flush_neighbors = 0                       # SSDå…³é—­é‚»å±…é¡µåˆ·
```



##### æ‰¹é‡åŠ è½½ä¸“ç”¨é…ç½®

```
# æ‰¹é‡åŠ è½½ä¼˜åŒ–
bulk_insert_buffer_size = 512M
max_allowed_packet = 1G
net_buffer_length = 16M
read_buffer_size = 8M
read_rnd_buffer_size = 4M
sort_buffer_size = 4M
join_buffer_size = 4M
tmp_table_size = 256M
max_heap_table_size = 256M

# äº‹åŠ¡å’Œé”
transaction_isolation = READ-COMMITTED
innodb_lock_wait_timeout = 300
lock_wait_timeout = 300
innodb_rollback_on_timeout = ON
innodb_autoinc_lock_mode = 2                   
```



##### InnoDBé«˜çº§ä¼˜åŒ–



##### JDBCè¿æ¥å­—ç¬¦ä¸²ä¼˜åŒ–

###### æ ‡å‡†MySQL JDBC URL

```java
String url = "jdbc:mysql://tdsql-host:3306/database?"
    + "useSSL=false&"
    + "rewriteBatchedStatements=true&"      // æ‰¹é‡è¯­å¥é‡å†™
    + "useServerPrepStmts=false&"           // ç¦ç”¨æœåŠ¡å™¨ç«¯é¢„ç¼–è¯‘
    + "cachePrepStmts=false&"               // ç¦ç”¨é¢„ç¼–è¯‘ç¼“å­˜
    + "useLocalSessionState=true&"          // ä½¿ç”¨æœ¬åœ°ä¼šè¯çŠ¶æ€
    + "useLocalTransactionState=true&"
    + "maintainTimeStats=false&"            // å‡å°‘ç›‘æ§å¼€é”€
    + "elideSetAutoCommits=true&"           // ä¼˜åŒ–è‡ªåŠ¨æäº¤
    + "cacheServerConfiguration=true&"      // ç¼“å­˜æœåŠ¡å™¨é…ç½®
    + "dontTrackOpenResources=true&"        // ä¸è·Ÿè¸ªæ‰“å¼€èµ„æº
    + "useUnbufferedInput=false&"           // ä½¿ç”¨ç¼“å†²è¾“å…¥
    + "zeroDateTimeBehavior=convertToNull&"
    + "characterEncoding=utf8mb4&"
    + "connectionCollation=utf8mb4_general_ci&"
    + "socketTimeout=3600000&"               // 1å°æ—¶socketè¶…æ—¶
    + "connectTimeout=30000&"
    + "autoReconnect=true&"
    + "failOverReadOnly=false";
```

###### TDSQLä¸“ç”¨å‚æ•°ï¼ˆå¦‚æœæ”¯æŒï¼‰

```java
String tdsqlUrl = url 
    + "&tdsqlLoadDataMode=fast"              // TDSQLå¿«é€ŸåŠ è½½æ¨¡å¼
    + "&tdsqlSkipSlaveCheck=true"            // è·³è¿‡ä»åº“æ£€æŸ¥
    + "&tdsqlBatchSize=1000000";             // æ‰¹é‡å¤§å°
```



#### æ“ä½œç³»ç»Ÿç¯å¢ƒä¼˜åŒ–

##### Linuxç³»ç»Ÿå‚æ•°ä¼˜åŒ–

```
# ç¼–è¾‘ /etc/sysctl.conf
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 10000
net.core.somaxconn = 65535
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_max_syn_backlog = 65536
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 0  # ä¸å»ºè®®å¼€å¯ï¼Œå¯èƒ½å¯¼è‡´NATé—®é¢˜

# æ–‡ä»¶ç³»ç»Ÿå‚æ•°
vm.swappiness = 10
vm.dirty_ratio = 60
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 3000
vm.dirty_writeback_centisecs = 500
fs.file-max = 65535
fs.aio-max-nr = 1048576

# åº”ç”¨é…ç½®
sysctl -p
```



##### æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¼˜åŒ–



##### ç£ç›˜è°ƒåº¦å™¨ä¼˜åŒ–ï¼ˆSSDï¼‰



#### å‚æ•°è°ƒä¼˜ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰

1. **ğŸ”¥ ç´§æ€¥ä¼˜åŒ–ï¼ˆç«‹å³è§æ•ˆï¼‰**
   - `unique_checks = 0`
   - `foreign_key_checks = 0`
   - `sql_log_bin = 0`
   - æ–‡ä»¶æ‹†åˆ†ï¼ˆé¿å…è¶…å¤§äº‹åŠ¡ï¼‰
2. **âš¡ é‡è¦ä¼˜åŒ–ï¼ˆæ•ˆæœæ˜¾è‘—ï¼‰**
   - `innodb_buffer_pool_size`ï¼ˆå¢å¤§ï¼‰
   - `innodb_log_file_size`ï¼ˆå¢å¤§ï¼‰
   - `max_allowed_packet`ï¼ˆå¢å¤§ï¼‰
   - ä½¿ç”¨SSDå­˜å‚¨
3. **âœ¨ è¿›é˜¶ä¼˜åŒ–ï¼ˆè¾¹é™…æ”¶ç›Šï¼‰**
   - `innodb_io_capacity`ï¼ˆè°ƒæ•´ï¼‰
   - `innodb_flush_method`ï¼ˆä¼˜åŒ–ï¼‰
   - æ“ä½œç³»ç»Ÿå‚æ•°è°ƒä¼˜
   - ç½‘ç»œå‚æ•°ä¼˜åŒ–
