## å†’çƒŸæµ‹è¯•ç®€å•æµç¨‹



`Jdk21`



### `application.yml`é…ç½®

#### ä¿®æ”¹ç›‘å¬ç«¯å£

â€‹	`server.port`



#### ä¿®æ”¹ç›®æ ‡æ•°æ®æº 

#### 	`spring.datasource`



#### è‡ªå®šä¹‰é…ç½®

##### 	æºç«¯`ibm csv`é…ç½®

â€‹		`app.csv.ibm-source`

â€‹	

##### 	ä¸­é—´`csv`æ‹†åˆ†æ–‡ä»¶é…ç½®

â€‹		`app.csv.utf8-split`



##### 	æ€§èƒ½é…ç½®

â€‹		`app.performance`

â€‹	

##### 	çº¿ç¨‹æ± é…ç½®

###### 		è½¬ç 

â€‹			`app.migration-thread-pool.transcode`

###### 		è£…è½½

â€‹			`app.migration-thread-pool.load`

###### 		éªŒè¯	

â€‹			`app.migration-thread-pool.verify`



##### 	ç¨‹åºå·¥ä½œç›®å½•é…ç½®

â€‹		`app.job`

â€‹	`outputDir` æ‹†åˆ†æ–‡ä»¶è¾“å‡ºç›®å½•

â€‹	`errorDir` é”™è¯¯ä¿¡æ¯ç›®å½•



##### è£…è½½`jdbc`é…ç½®	

â€‹	`preSqlList`è£…è½½å‰é¢„å…ˆæ‰§è¡Œ`sql`

â€‹	`urlOptions` è£…è½½`jdbc url`é…ç½®



##### éªŒè¯

â€‹	`app.verify`

â€‹		

â€‹	éªŒè¯ç­–ç•¥ `strategy`

â€‹		`USE_SOURCE_FILE`: æºæ–‡ä»¶å’Œ`tdsql`æ•°æ®è¿›è¡Œæ¯”å¯¹, `USE_UTF8_SPLIT`ç”¨æ‹†åˆ†æ–‡ä»¶å’Œ`tdsql`æ•°æ®è¿›è¡ŒéªŒè¯

â€‹	`maxDiffCount`

â€‹		æœ€å¤§å·®å¼‚è¡Œ, è¶…è¿‡åç»“æŸæ¯”å¯¹

â€‹	`verifyResultBasePath`

â€‹		éªŒè¯ç»“æœæŠ¥é”™ä¿å­˜ç›®å½•



### æ¸…ç†æ¼”ç¤ºç¯å¢ƒ

```sql
drop table if exists test1.csv_split;
drop table if exists test1.qianyi_detail;
drop table if exists test1.qianyi;
drop table if exists test1.migration_job;

drop table test2.t_user_info;
drop table test2.t_info;
```



### åœ¨ç›®æ ‡åº“å»ºè¡¨

è¿ç§»ç¨‹åºä¸ä¼šè‡ªåŠ¨å»ºè¡¨

```mysql
CREATE TABLE test2.t_user_info (
  `user_id` varchar(50) DEFAULT NULL,
  `user_name` varchar(100) DEFAULT NULL,
  `balance` decimal(10,2) DEFAULT NULL,
  `csvid` bigint(20) DEFAULT NULL,
  `source_row_no` bigint(20) DEFAULT NULL,
  KEY `idx_csvid_rowno` (`csvid`,`source_row_no`)
) ENGINE=InnoDB DEFAULT CHARSET=gbk;

create table test2.t_info like test2.t_user_info;
```



è¯´æ˜ï¼šå®é™…çš„åˆ†å¸ƒå¼`tdsql`ç¯å¢ƒï¼Œéœ€è¦ç»™åˆ†ç‰‡é”®ã€‚åˆ†ç‰‡é”®é€‰æ‹©ä¸è€ƒè™‘ä¸šåŠ¡åœºæ™¯ï¼Œåªè€ƒè™‘åŒæ­¥æ€§èƒ½ã€‚é€‰æ‹©`csvid`åšåˆ†ç‰‡é”®ï¼Œè¿™æ ·åŒä¸€ä¸ªæ‹†åˆ†`csv`æ–‡ä»¶æ•°æ®(`load data infile`)éƒ½åŠ è½½åˆ°åŒä¸€ä¸ªåˆ†ç‰‡ä¸­ã€‚

å®é™…çš„`tdsql`ç¯å¢ƒå»ºè¡¨è¯­å¥

```sql
CREATE TABLE test2.t_user_info (
  `user_id` varchar(50) DEFAULT NULL,
  `user_name` varchar(100) DEFAULT NULL,
  `balance` decimal(10,2) DEFAULT NULL,
  `csvid` bigint(20) DEFAULT NULL,
  `source_row_no` bigint(20) DEFAULT NULL,
  KEY `idx_csvid_rowno` (`csvid`,`source_row_no`)
) shardkey=`csvid` ENGINE=InnoDB DEFAULT CHARSET=gbk;

create table test2.t_info like test2.t_user_info;
```



### ç•Œé¢æ–°åŠ è¿ç§»ä½œä¸š

ç™»å½•ï¼šhttp://localhost:8080/



#### æ–°å»ºè¿ç§»ä½œä¸š

```
ä½œä¸šåç§°ï¼šç”¨æˆ·è¡¨è¿ç§»
ç›‘æ§ç›®å½•: D:/data/ibm_input
ç›®æ ‡æ•°æ®åº“URLï¼š jdbc:mysql://æ•°æ®åº“ip:ç«¯å£/test2
```



è¯´æ˜ï¼šæŒ‰æ¯ä¸ªåˆ†ç‰‡å»ºè¿ç§»ä½œä¸šï¼Œæ¯ä¸ªåˆ†ç‰‡çš„ä½œä¸šç›‘æ§ç›®æ ‡ä¸ä¸€æ ·(ä¹Ÿè¡Œåœ¨ä¸åŒçš„è¿ç§»æœºå™¨ä¸Š)



#### åˆ›å»ºè¿ç§»è¯·æ±‚

ä¸Šä¼ `csv`æ–‡ä»¶åˆ°è¿ç§»ç›®å½•

1) ä¸Šä¼  `data_01.csv, data_02.csv, data_03.csv, data_04.csv` åˆ°è¿ç§»æœºå™¨

2) ä¸Šä¼  è¡¨ç»“æ„å®šä¹‰æ–‡ä»¶ `t_info.sql` åˆ°è¿ç§»æœºå™¨

   ç¤ºä¾‹è¡¨ç»“æ„æ–‡ä»¶ `t_info.sql`

   æ–‡æœ¬æ ¼å¼ï¼Œæ¯ä¸€è¡Œæ˜¯è¡¨çš„åˆ—åå’Œç±»å‹ï¼Œç›®å‰åªç”¨åˆ°åˆ—å

   ```
   user_id,varchar
   user_name,varchar
   balance,decimal
   ```

   

3) ä¸Šä¼ `ok`æ–‡ä»¶ `info.ok`

   ç¤ºä¾‹`info.ok'æ–‡ä»¶

   ```json
   {
     "ddl": "D:/data/ibm_input/t_info.sql",
     "csv": [
       "D:/data/ibm_input/t_01.csv",
       "D:/data/ibm_input/t_02.csv",
       "D:/data/ibm_input/t_03.csv",
       "D:/data/ibm_input/t_04.csv"
     ]
   }
   ```

   æ–‡ä»¶æ ¼å¼è¯´æ˜ï¼Œ `json`æ ¼å¼

   `ddl`æŒ‡å®šè¡¨ç»“æ„å®šä¹‰æ–‡ä»¶ï¼ˆå…¨è·¯å¾„)

   `csv`å®šä¹‰æ•°æ®æ–‡ä»¶å…¨è·¯å¾„ï¼ˆå¯ä»¥æœ‰å¤šä¸ªï¼‰



`ok`æ–‡ä»¶ä¸Šä¼ åï¼Œè¿ç§»è‡ªåŠ¨å¼€å§‹



å¯ä»¥ç»§ç»­ä¸Šä¼ å…¶ä»–è¿ç§»è¯·æ±‚

æ¯”å¦‚ä¸Šä¼ `csv`æ–‡ä»¶   `t_01.csv, t_02.csv, t_03.csv, t_04.csv` , ä¸Šä¼ è¡¨ç»“æ„å®šä¹‰ `t_user_info.sql`, ç„¶åä¸Šä¼ `ok`æ–‡ä»¶ `user_info.ok`



#### ç›‘çœ‹è¿ç§»è¿‡ç¨‹

åœ¨ç•Œé¢æŸ¥çœ‹è¿ç§»è¿‡ç¨‹



### ç¯å¢ƒä¼˜åŒ–

è¯´æ˜ï¼šä¸‹é¢çš„é…ç½®æ²¡æœ‰éªŒè¯ï¼Œä»…ä¾›å‚è€ƒ



#### æ•°æ®åº“é…ç½®ä¼˜åŒ–



##### å¯åŠ¨ä¼˜åŒ–ä¼šè¯ï¼ˆéœ€è¦SUPERæƒé™ï¼‰

```
SET GLOBAL innodb_buffer_pool_size = 17179869184;  -- 16GBï¼Œæ ¹æ®å†…å­˜è°ƒæ•´
SET GLOBAL innodb_log_file_size = 4294967296;      -- 4GB
SET GLOBAL innodb_log_buffer_size = 268435456;     -- 256MB
SET GLOBAL innodb_flush_log_at_trx_commit = 2;     -- é™ä½åˆ·ç›˜é¢‘ç‡
SET GLOBAL sync_binlog = 0;                        -- å…³é—­binlogåŒæ­¥
SET GLOBAL max_allowed_packet = 1073741824;        -- 1GB
SET GLOBAL net_buffer_length = 16777216;           -- 16MB
SET GLOBAL bulk_insert_buffer_size = 536870912;    -- 512MB
SET GLOBAL innodb_io_capacity = 4000;              -- SSDå»ºè®®å€¼
SET GLOBAL innodb_io_capacity_max = 8000;
SET GLOBAL innodb_read_io_threads = 8;
SET GLOBAL innodb_write_io_threads = 8;
SET GLOBAL innodb_purge_threads = 4;
SET GLOBAL innodb_page_cleaners = 4;
SET GLOBAL innodb_adaptive_flushing = ON;
SET GLOBAL innodb_flush_neighbors = 0;             -- SSDå»ºè®®å…³é—­
SET GLOBAL innodb_doublewrite = 0;                 -- ä»…æ‰¹é‡åŠ è½½æ—¶å…³é—­
SET GLOBAL innodb_checksum_algorithm = none;       -- å…³é—­æ ¡éªŒ
SET GLOBAL innodb_log_compressed_pages = OFF;      -- å‡å°‘æ—¥å¿—å¤§å°
SET GLOBAL thread_pool_size = 32;                  -- æ ¹æ®CPUæ ¸å¿ƒæ•°
```

###### TDSQLç‰¹æœ‰å‚æ•°ï¼ˆå¦‚æœé€‚ç”¨ï¼‰

```
-- TDSQLåˆ†å¸ƒå¼ä¼˜åŒ–
SET GLOBAL tdsql_batch_commit_size = 1000000;
SET GLOBAL tdsql_parallel_load_threads = 8;
SET GLOBAL tdsql_skip_slave_check = 1;      -- è·³è¿‡ä»åº“æ£€æŸ¥
SET GLOBAL tdsql_load_data_memory_limit = 4294967296;  -- 4GBå†…å­˜é™åˆ¶
```



##### é…ç½®æ–‡ä»¶æ°¸ä¹…è®¾ç½®ï¼ˆmy.cnf / my.iniï¼‰

###### å†…å­˜ä¼˜åŒ–ï¼ˆæ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´ï¼‰

```
 å†…å­˜é…ç½®ï¼ˆ64GBå†…å­˜æœåŠ¡å™¨ç¤ºä¾‹ï¼‰
innodb_buffer_pool_size = 48G                    # ç³»ç»Ÿå†…å­˜çš„70-75%
innodb_buffer_pool_instances = 8                 # æ¯ä¸ªå®ä¾‹è‡³å°‘1GB
innodb_log_buffer_size = 256M
innodb_log_file_size = 4G                        # æ¯ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°
innodb_log_files_in_group = 2                    # æ€»å…±8GBæ—¥å¿—ç©ºé—´

# è¿æ¥ç›¸å…³
max_connections = 1000
max_connect_errors = 100000
connect_timeout = 60
wait_timeout = 28800
interactive_timeout = 28800
```



##### IOä¼˜åŒ–ï¼ˆSSDç¡¬ç›˜æ¨èï¼‰

```
# IOä¼˜åŒ–
innodb_flush_method = O_DIRECT                   # Linuxä½¿ç”¨O_DIRECTï¼ŒWindowsä½¿ç”¨async_unbuffered
innodb_flush_log_at_trx_commit = 2               # æ‰¹é‡åŠ è½½ä¼˜åŒ–
innodb_doublewrite = 0                           # æ‰¹é‡åŠ è½½æ—¶å…³é—­
innodb_file_per_table = ON
innodb_data_file_path = ibdata1:1G:autoextend
innodb_autoextend_increment = 128

# SSDä¼˜åŒ–
innodb_io_capacity = 4000
innodb_io_capacity_max = 8000
innodb_read_io_threads = 8
innodb_write_io_threads = 8
innodb_flush_neighbors = 0                       # SSDå…³é—­é‚»å±…é¡µåˆ·
```



##### æ‰¹é‡åŠ è½½ä¸“ç”¨é…ç½®

```
# æ‰¹é‡åŠ è½½ä¼˜åŒ–
bulk_insert_buffer_size = 512M
max_allowed_packet = 1G
net_buffer_length = 16M
read_buffer_size = 8M
read_rnd_buffer_size = 4M
sort_buffer_size = 4M
join_buffer_size = 4M
tmp_table_size = 256M
max_heap_table_size = 256M

# äº‹åŠ¡å’Œé”
transaction_isolation = READ-COMMITTED
innodb_lock_wait_timeout = 300
lock_wait_timeout = 300
innodb_rollback_on_timeout = ON
innodb_autoinc_lock_mode = 2                   
```



##### InnoDBé«˜çº§ä¼˜åŒ–



##### JDBCè¿æ¥å­—ç¬¦ä¸²ä¼˜åŒ–

###### æ ‡å‡†MySQL JDBC URL

```java
String url = "jdbc:mysql://tdsql-host:3306/database?"
    + "useSSL=false&"
    + "rewriteBatchedStatements=true&"      // æ‰¹é‡è¯­å¥é‡å†™
    + "useServerPrepStmts=false&"           // ç¦ç”¨æœåŠ¡å™¨ç«¯é¢„ç¼–è¯‘
    + "cachePrepStmts=false&"               // ç¦ç”¨é¢„ç¼–è¯‘ç¼“å­˜
    + "useLocalSessionState=true&"          // ä½¿ç”¨æœ¬åœ°ä¼šè¯çŠ¶æ€
    + "useLocalTransactionState=true&"
    + "maintainTimeStats=false&"            // å‡å°‘ç›‘æ§å¼€é”€
    + "elideSetAutoCommits=true&"           // ä¼˜åŒ–è‡ªåŠ¨æäº¤
    + "cacheServerConfiguration=true&"      // ç¼“å­˜æœåŠ¡å™¨é…ç½®
    + "dontTrackOpenResources=true&"        // ä¸è·Ÿè¸ªæ‰“å¼€èµ„æº
    + "useUnbufferedInput=false&"           // ä½¿ç”¨ç¼“å†²è¾“å…¥
    + "zeroDateTimeBehavior=convertToNull&"
    + "characterEncoding=utf8mb4&"
    + "connectionCollation=utf8mb4_general_ci&"
    + "socketTimeout=3600000&"               // 1å°æ—¶socketè¶…æ—¶
    + "connectTimeout=30000&"
    + "autoReconnect=true&"
    + "failOverReadOnly=false";
```

###### TDSQLä¸“ç”¨å‚æ•°ï¼ˆå¦‚æœæ”¯æŒï¼‰

```java
String tdsqlUrl = url 
    + "&tdsqlLoadDataMode=fast"              // TDSQLå¿«é€ŸåŠ è½½æ¨¡å¼
    + "&tdsqlSkipSlaveCheck=true"            // è·³è¿‡ä»åº“æ£€æŸ¥
    + "&tdsqlBatchSize=1000000";             // æ‰¹é‡å¤§å°
```



#### æ“ä½œç³»ç»Ÿç¯å¢ƒä¼˜åŒ–

##### Linuxç³»ç»Ÿå‚æ•°ä¼˜åŒ–

```
# ç¼–è¾‘ /etc/sysctl.conf
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 10000
net.core.somaxconn = 65535
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_max_syn_backlog = 65536
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 0  # ä¸å»ºè®®å¼€å¯ï¼Œå¯èƒ½å¯¼è‡´NATé—®é¢˜

# æ–‡ä»¶ç³»ç»Ÿå‚æ•°
vm.swappiness = 10
vm.dirty_ratio = 60
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 3000
vm.dirty_writeback_centisecs = 500
fs.file-max = 65535
fs.aio-max-nr = 1048576

# åº”ç”¨é…ç½®
sysctl -p
```



##### æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¼˜åŒ–



##### ç£ç›˜è°ƒåº¦å™¨ä¼˜åŒ–ï¼ˆSSDï¼‰



#### å‚æ•°è°ƒä¼˜ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰

1. **ğŸ”¥ ç´§æ€¥ä¼˜åŒ–ï¼ˆç«‹å³è§æ•ˆï¼‰**
   - `unique_checks = 0`
   - `foreign_key_checks = 0`
   - `sql_log_bin = 0`
   - æ–‡ä»¶æ‹†åˆ†ï¼ˆé¿å…è¶…å¤§äº‹åŠ¡ï¼‰
2. **âš¡ é‡è¦ä¼˜åŒ–ï¼ˆæ•ˆæœæ˜¾è‘—ï¼‰**
   - `innodb_buffer_pool_size`ï¼ˆå¢å¤§ï¼‰
   - `innodb_log_file_size`ï¼ˆå¢å¤§ï¼‰
   - `max_allowed_packet`ï¼ˆå¢å¤§ï¼‰
   - ä½¿ç”¨SSDå­˜å‚¨
3. **âœ¨ è¿›é˜¶ä¼˜åŒ–ï¼ˆè¾¹é™…æ”¶ç›Šï¼‰**
   - `innodb_io_capacity`ï¼ˆè°ƒæ•´ï¼‰
   - `innodb_flush_method`ï¼ˆä¼˜åŒ–ï¼‰
   - æ“ä½œç³»ç»Ÿå‚æ•°è°ƒä¼˜
   - ç½‘ç»œå‚æ•°ä¼˜åŒ–
