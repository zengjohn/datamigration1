# 数据迁移操作手册

## 1. 系统概述

本系统旨在解决从 IBM 大机（EBCDIC 编码/IBM-1388）到开放平台数据库（TDSQL/UTF-8）的高性能数据迁移、清洗与校验问题。

系统采用 **"转码 -> 拆分 -> 并发装载 -> 逐行比对"** 的流水线架构，确保数据零丢失、零差错。

## 2. 核心概念

- **Job (作业)**：对应一个源数据目录，包含多个批次文件（如 `/data/source/job1/`）。
- **Batch (批次/迁移单)**：对应源目录下的一个 `.ok` 信号文件。一个批次包含多个 CSV 数据文件。
- **Detail (文件明细)**：对应一个具体的 IBM-1388 源 CSV 文件。
- **Split (切片)**：为了提高并发，系统将源文件拆分为多个小切片（如 100000行/个），每个切片独立进行装载和校验。

## 3. 界面布局与基础操作

控制台分为四个区域：

1. **左侧栏 (作业区)**：新建、搜索、停止/恢复作业。
2. **顶部栏 (批次区)**：显示当前作业下的 OK 文件批次及状态。
3. **主视图 (文件明细)**：显示批次内每个 CSV 文件的转码进度、错误行数。
4. **右侧抽屉 (切片监控)**：**【核心运维区】**，显示某个 CSV 文件下的成百上千个切片的执行详情。

### 3.1 新建作业

点击右上角 **“+ 新建作业”**，填写：

- **监控源目录**：存放 IBM CSV 和 OK 文件的路径。
- **输出目录**：存放转码后的 UTF-8 CSV、差异报告的路径（建议使用大容量磁盘）。
- **JDBC配置**：目标数据库连接信息（务必确保 URL 包含 `serverTimezone` 以防时区问题）。

### 3.2 结单操作 (Close Batch)

当一个批次所有文件处理完毕（状态为 FINISHED），且不需要保留临时文件时：

- 在批次列表点击 **“强制结单” (绿色打钩图标)**。
- **注意**：结单后，系统会自动清理该批次下的所有临时切片、补丁文件和差异日志以释放磁盘空间。此操作不可逆。

------

## 4. 异常处理与运维 (重点)

### 4.1 场景一：转码失败 (FAIL_TRANSCODE)

**现象**：文件明细列表显示红色“转码失败”，或“失败行数”异常高。 

**操作**：

1. 点击“失败行数”旁边的 **[查看]** 链接，预览具体的乱码内容。
2. 如果是因为源文件损坏严重，联系上游重新发数。
3. 如果是偶发 I/O 问题，点击 **“重试转码”** 按钮。

### 4.2 场景二：装载失败 (FAIL_LOAD)

**现象**：切片监控抽屉中，出现红色 `FAIL_LOAD` 状态。通常由于数据库死锁、网络抖动或数据类型不匹配引起。 

**操作**：

- **单条修复**：点击该切片右侧的 **“重试加载”** 按钮。
- **批量修复**：如果大量切片失败（如网络闪断），点击工具栏上的 **“⚡ 批量重装”** 按钮。系统会在后台排队重试所有失败任务。

### 4.3 场景三：验证不一致 (FAIL_VERIFY)

**现象**：装载成功，但比对发现源文件与数据库不一致。 

**操作**：

1. 点击 **“查看差异”** 按钮，系统会展示具体的差异行号和差异字段（Left: CSV, Right: DB）。
2. **自动修复**：如果是因为之前装载时有干扰，点击 **“重载”**（会删除旧数据->重新入库->重新校验）。
3. **人工兜底 (Patch 机制)**：见下文 4.4。
4. **批量修复**：如果大量切片失败，点击工具栏上的 **“⚡ 批量重验”** 按钮。系统会在后台排队重试所有失败任务。

### 4.4 场景四：源数据乱码/无法入库 (Patch 补丁修复)

**场景**：源 IBM 文件某行确实是乱码，或者包含数据库无法接受的字符，导致校验永远不通过。 

**操作流程**：

1. 在切片列表点击 **“下载”**，获取 `split_xxx.csv` 到本地。
2. 使用文本编辑器修正错误数据（如删除乱码字符）。
3. 将修正后的文件重命名为 `split_xxx.csv.patch`。
4. 上传该 `.patch` 文件到服务器对应的切片目录下。
5. 在控制台点击 **“重载”**重新装载 。
   - *系统机制：一旦发现同名 `.patch` 文件，将以 Patch 文件内容为“真理”进行入库和比对，自动忽略原始错误文件。*

### 4.5 场景五：任务卡死 (僵尸任务)

**现象**：状态长时间停留在 `LOADING` 或 `VERIFYING`，进度条不动。 

**机制**：

- 系统内置“僵尸进程杀手”，每 60 秒扫描一次。
- 如果任务卡住超过 **30分钟**，系统会自动将其重置为 `WAIT_LOAD`，等待重新调度。
- **运维无需干预**，只需耐心等待自动恢复。如果频繁出现，请检查数据库时区配置。

------

## 5. 状态流转图解

```
[NEW] 新发现文件
  ↓ (自动调度)
[TRANSCODING] 转码中
  ↓
  ├─→ [FAIL_TRANSCODE] 转码失败 (需人工重试)
  ↓
[PROCESSING_CHILDS] 正在处理子切片 (进入切片微观管理)
  ↓
  ├─→ Split: WAIT_LOAD
  ├─→ Split: LOADING (DB自动更新时间)
  ├─→ Split: WAIT_VERIFY
  ├─→ Split: VERIFYING
  ├─→ Split: PASS (验证通过，自动删除临时文件)
  │      ↓
  └─→ Split: FAIL_LOAD / FAIL_VERIFY (需人工介入/Patch修复)
```

## 6. 常见问题 (FAQ)

**Q1: 为什么有时候显示“装载失败”，但我手动一点重试就成功了？** A: 大规模并发装载时，数据库可能会产生临时的行锁竞争或网络拥塞。系统虽然有 3 次自动重试机制，但极少数情况下仍会耗尽次数。此时手动重试即可。

**Q2: “结单”和“验证通过”有什么区别？** A: “验证通过”是针对单个切片的，此时切片数据已准确入库。而“结单”是针对整个批次（OK文件）的。**结单操作可以触发最终的磁盘大清理**。

**Q3: 如何处理时间格式不一致导致的校验失败？** A: 系统内核已升级比对算法，自动兼容 `2024/1/1 12:00` (CSV) 与 `2024-01-01 12:00:00` (DB) 的差异。如果仍报错，请检查源数据是否确实有误。

------

**技术支持**

- 后端服务端口：8080
- 日志路径：`/logs/app.log`
- 配置文件：`application.yml`